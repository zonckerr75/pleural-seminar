<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pleural Seminar — Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b1320;--panel:#0f172a;--fg:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--border:#1f2937;--warn:#7c2d12;--warn-bg:#2b1d12}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    .wrap{max-width:720px;margin:40px auto;padding:24px;background:var(--panel);border:1px solid var(--border);border-radius:16px}
    h1{margin:0 0 8px}
    p.muted{color:var(--muted);margin-top:0}
    label{display:block;margin:16px 0 6px}
    input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:#0b1426;color:#e5e7eb}
    button, a.button{display:inline-block;text-decoration:none;padding:12px 16px;border:0;border-radius:12px;background:var(--accent);color:#03120a;font-weight:600;cursor:pointer}
    a.secondary, button.secondary{background:#1f2937;color:#e5e7eb}
    .row{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap;align-items:center;justify-content:flex-start}
    .msg{margin-top:16px;padding:12px;border-radius:12px;background:#0b1426;border:1px solid var(--border)}
    .ok{border-color:#164e2e}.warn{border-color:var(--warn);background:var(--warn-bg)}
    .hidden{display:none}
    .logo-link{display:block;text-align:center;margin-top:18px;text-decoration:none;color:#22c55e}
    .logo-link img{height:50px;display:block;margin:0 auto 8px}
    /* Custom disabled that still allows click to show a toast */
    .is-disabled{opacity:0.7;cursor:not-allowed;filter:grayscale(20%)}
    /* Tiny toast under buttons */
    #toast{margin-top:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--warn);background:var(--warn-bg);color:#fcd9b6;display:none}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // Firebase config (shared across your site)
    const firebaseConfig = {
      apiKey: "AIzaSyAZq933hFxLT1K49auoZjBnYWEdi2mKUFI",
      authDomain: "pleural-seminar-2025.firebaseapp.com",
      projectId: "pleural-seminar-2025",
      storageBucket: "pleural-seminar-2025.appspot.com",
      messagingSenderId: "914784082205",
      appId: "1:914784082205:web:448e2d4fe8e9579075a9f4"
    };

    const EVENT_ID   = "pleural-2025";
    const EVENT_DATE = "2025-11-14"; // attendance/{date}/checkins/{token}

    // DOM helpers
    const el = id => document.getElementById(id);
    const decodeName = s => decodeURIComponent((s||"").replace(/\+/g," "));
    const fmtTS = ts => { try { return new Date(ts.seconds*1000).toLocaleString("en-GB",{hour12:false}); } catch { return "—"; } };

    // Robust query parsing
    function readParams() {
      const raw = location.search.startsWith("?") ? location.search.slice(1) : location.search;
      const map = {};
      raw.split("&").filter(Boolean).forEach(kv => {
        const [k,v=""] = kv.split("=");
        if (!k) return;
        map[decodeURIComponent(k).toLowerCase()] = decodeURIComponent(v||"");
      });
      const token = (map.token || map.code || map.t || map.id || "").trim() || (!raw.includes("=") ? decodeURIComponent(raw).trim() : "");
      const n = (map.n || map.name || "").trim();
      const e = (map.e || map.email || "").trim();
      return { raw, token, n, e };
    }

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    function regRef(date, token){ return doc(db, "attendance", date, "checkins", token); }

    // Normalize email: trim, strip whitespace, Unicode-normalize
    function normalizeEmail(s){
      return (s || "").normalize("NFKC").trim().replace(/\\s+/g, "");
    }
    // Use the browser's own email validator if possible
    function isValidEmail(inputEl){
      inputEl.value = normalizeEmail(inputEl.value);
      if (typeof inputEl.checkValidity === "function") return inputEl.checkValidity();
      return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(inputEl.value);
    }

    // Toast helper (5s auto-hide)
    let toastTimer = null;
    function showToast(msg){
      const t = el("toast");
      t.textContent = msg;
      t.style.display = "block";
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{ t.style.display = "none"; }, 5000);
    }

    // Toggle UI after confirmed
    function onConfirmed(){
      // Check-In button -> grey + looks disabled, text changes
      const btn = el("btnConfirm");
      btn.classList.add("secondary","is-disabled");
      btn.textContent = "Checked-In";
      // Feedback button -> green + enabled
      const fb = el("feedbackBtn");
      fb.classList.remove("secondary","is-disabled");
      // short vibration
      if (navigator.vibrate) navigator.vibrate([80]);
      // clear any prior toasts
      showToast(""); el("toast").style.display = "none";
    }

    async function init(){
      const qp = readParams();

      if (!qp.token){
        el("content").classList.add("hidden");
        el("error").classList.remove("hidden");
        return;
      }

      // Prefill from URL first
      if (qp.n) el("name").value = decodeName(qp.n);
      if (qp.e) el("email").value = qp.e;

      // Welcome text uses the best-known name
      el("welcomeName").textContent = el("name").value || "Attendee";

      // Prefill from Firestore if needed
      const attRef = doc(db, "attendees", qp.token);
      try {
        const attSnap = await getDoc(attRef);
        if (attSnap.exists()){
          const d = attSnap.data() || {};
          if (!el("name").value && d.name)   el("name").value = d.name;
          if (!el("email").value && d.email) el("email").value = d.email;
          if (el("name").value) el("welcomeName").textContent = el("name").value;
        }
      } catch (e){ console.warn("attendees prefill failed:", e); }

      // Build feedback link
      const href = "feedback.html?" + new URLSearchParams({ token: qp.token, n: el("name").value || "", e: el("email").value || "" }).toString();
      el("feedbackBtn").href = href;

      // Start with feedback disabled look
      el("feedbackBtn").classList.add("secondary","is-disabled");

      // Duplicate-scan check (if already checked-in, set UI immediately)
      const rRef = regRef(EVENT_DATE, qp.token);
      try {
        const rSnap = await getDoc(rRef);
        if (rSnap.exists()){
          const d = rSnap.data() || {};
          el("already").classList.remove("hidden");
          el("prevTime").textContent = fmtTS(d.checkedInAt);
          onConfirmed();
        }
      } catch (e){ console.warn("attendance read failed:", e); }

      // Keep feedback link synced with current inputs
      const sync = () => el("feedbackBtn").href = "feedback.html?" + new URLSearchParams({ token: qp.token, n: el("name").value.trim(), e: normalizeEmail(el("email").value) }).toString();
      el("name").addEventListener("input", ()=>{ el("welcomeName").textContent = el("name").value || "Attendee"; sync(); });
      el("email").addEventListener("input", sync);

      // Intercept clicks when disabled-look
      el("btnConfirm").addEventListener("click", (e)=>{
        if (el("btnConfirm").classList.contains("is-disabled")){
          e.preventDefault();
          showToast("You’ve already checked in.");
        }
      });
      el("feedbackBtn").addEventListener("click", (e)=>{
        if (el("feedbackBtn").classList.contains("is-disabled")){
          e.preventDefault();
          showToast("Please check-in first.");
        }
      });

      // Confirm handler (actual action)
      el("btnConfirm").addEventListener("click", async (ev)=>{
        if (el("btnConfirm").classList.contains("is-disabled")) return; // blocked
        try {
          const nameInput  = el("name");
          const emailInput = el("email");
          const name  = nameInput.value.trim();
          const email = normalizeEmail(emailInput.value);

          if (!name){
            el("msg").className="msg warn"; el("msg").textContent="Please confirm your name."; return;
          }
          if (!isValidEmail(emailInput)){
            el("msg").className="msg warn"; el("msg").textContent="Please enter a valid email address."; emailInput.reportValidity?.(); return;
          }

          // Upsert attendees/{token}
          await setDoc(attRef, { name, email, updatedAt: serverTimestamp() }, { merge:true });

          // Create (or report existing) attendance/{date}/checkins/{token}
          const existing = await getDoc(rRef);
          if (existing.exists()){
            const d = existing.data() || {};
            const when = fmtTS(d.checkedInAt);
            el("already").style.display = "";
            el("prevTime").textContent = when;
            el("msg").className = "msg ok";
            el("msg").textContent = `Already checked in at ${when}.`;
            onConfirmed();
          } else {
            await setDoc(rRef, { eventId: EVENT_ID, name, email, checkedInAt: serverTimestamp() });
            el("already").style.display = "none";
            el("msg").className = "msg ok";
            el("msg").textContent = "You’ve checked-in. Please provide feedback at the end by scanning your QR code again. You can download your attendance certificate from there. Enjoy the seminar!";
            onConfirmed();
          }

          // Update feedback link with confirmed details
          sync();

        } catch (err){
          console.error(err);
          el("msg").className = "msg warn";
          el("msg").textContent = `Error: ${err.message || err}`;
        }
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  </script>
</head>
<body>
  <div class="wrap" id="content">
    <h1>Welcome, <span id="welcomeName">Attendee</span></h1>
    <p class="muted">Please confirm your details to complete check-in.</p>

    <label for="name">Name</label>
    <input id="name" type="text" placeholder="Your full name" />

    <label for="email">Email</label>
    <input id="email" type="email" placeholder="name@example.com" required />

    <div class="row">
      <button id="btnConfirm">Check-In</button>
      <a id="feedbackBtn" class="button secondary" href="#" role="button">Give Feedback</a>
    </div>

    <!-- Gentle toast under buttons -->
    <div id="toast" class="warn" aria-live="polite"></div>

    <!-- Logo + caption link to main site (same tab) -->
    <a class="logo-link" href="https://pleuralseminar.wales">
      <img src="/assets/branding/logo.png" alt="Pleural Seminar Wales">
      <div>Click to proceed to the main event page</div>
    </a>

    <div id="msg" class="msg hidden"></div>

    <div id="already" class="msg" style="display:none">
      Duplicate scan — already checked in at: <strong id="prevTime">—</strong>
    </div>
  </div>

  <div class="wrap hidden" id="error">
    <h2>Badge token missing</h2>
    <p class="muted">This page must be opened from your QR badge link.</p>
  </div>
</body>
</html>
