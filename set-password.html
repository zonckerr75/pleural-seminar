
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Set Password ‚Äî PleuraWales</title>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background:#020617;
      color:#e5e7eb;
      margin:0;
      padding:20px;
      display:flex;
      justify-content:center;
    }

    .card {
      background:#0f172a;
      padding:24px;
      border-radius:16px;
      border:1px solid #1e293b;
      max-width:420px;
      width:100%;
    }

    h1 { margin-top:0; }

    .field { margin-bottom:16px; }

    .password-wrapper {
      position:relative;
      display:flex;
      align-items:center;
    }

    .password-wrapper input {
      width:100%;
      padding:10px 38px 10px 12px;
      border-radius:10px;
      border:1px solid #334155;
      background:#0f172a;
      color:#e5e7eb;
      font-size:1rem;
    }

    .password-toggle {
      position:absolute;
      right:10px;
      background:none;
      border:none;
      cursor:pointer;
      color:#94a3b8;
      font-size:1rem;
    }

    .btn {
      width:100%;
      padding:10px;
      border-radius:10px;
      border:none;
      background:#38bdf8;
      color:#0f172a;
      cursor:pointer;
      font-weight:600;
      font-size:1rem;
    }

    .error { color:#fca5a5; font-size:0.85rem; }
    .success { color:#86efac; font-size:0.9rem; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Set your password</h1>
    <p id="status-text">Validating link‚Ä¶</p>

    <form id="password-form">
      <div class="field">
        <label>New password</label>
        <div class="password-wrapper">
          <input type="password" id="password" required minlength="8"/>
          <button type="button" class="password-toggle" id="toggle1">üëÅ</button>
        </div>
      </div>

      <div class="field">
        <label>Confirm password</label>
        <div class="password-wrapper">
          <input type="password" id="password2" required minlength="8"/>
          <button type="button" class="password-toggle" id="toggle2">üëÅ</button>
        </div>
      </div>

      <p class="error" id="msg-error" hidden></p>
      <p class="success" id="msg-success" hidden></p>

      <button type="submit" class="btn" id="submit-btn">Save password</button>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, verifyPasswordResetCode, confirmPasswordReset } 
      from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAZq933hFxLT1K49auoZjBnYWEdi2mKUFI",
      authDomain: "pleural-seminar-2025.firebaseapp.com",
      projectId: "pleural-seminar-2025",
      storageBucket: "pleural-seminar-2025.appspot.com",
      messagingSenderId: "914784082205",
      appId: "1:914784082205:web:448e2d4fe8e9579075a9f4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const params = new URLSearchParams(window.location.search);
    const oobCode = params.get("oobCode");

    const form = document.getElementById("password-form");
    const statusText = document.getElementById("status-text");
    const err = document.getElementById("msg-error");
    const ok = document.getElementById("msg-success");

    const p1 = document.getElementById("password");
    const p2 = document.getElementById("password2");

    function toggle(btnId, input) {
      const btn = document.getElementById(btnId);
      btn.addEventListener("click", () => {
        const isPass = input.type === "password";
        input.type = isPass ? "text" : "password";
        btn.textContent = isPass ? "üôà" : "üëÅ";
      });
    }

    toggle("toggle1", p1);
    toggle("toggle2", p2);

    if (!oobCode) {
      statusText.textContent = "Invalid or missing link. Please request a new reset email.";
      form.style.display = "none";
    } else {
      verifyPasswordResetCode(auth, oobCode)
        .then(email => {
          statusText.textContent = "Setting password for " + email;
        })
        .catch(e => {
          statusText.textContent = "This link is invalid or expired.";
          form.style.display = "none";
        });
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      err.hidden = true;
      ok.hidden = true;

      if (p1.value.length < 8) {
        err.textContent = "Password must be at least 8 characters.";
        err.hidden = false;
        return;
      }

      if (p1.value !== p2.value) {
        err.textContent = "Passwords do not match.";
        err.hidden = false;
        return;
      }

      try {
        await confirmPasswordReset(auth, oobCode, p1.value);
        ok.textContent = "Password updated. Redirecting to login‚Ä¶";
        ok.hidden = false;

        setTimeout(() => {
          window.location.href = "login.html";
        }, 1800);

      } catch (e) {
        err.textContent = "Could not set password. Link may be expired.";
        err.hidden = false;
      }
    });
  </script>

</body>
</html>
