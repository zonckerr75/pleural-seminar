<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Faculty ‚Äî Pleural Seminar Wales 2025</title>
  <meta name="color-scheme" content="dark">
  <style>
    :root{--bg:#0b1320;--panel:#0f172a;--fg:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--border:#1f2937}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    .app{display:flex;min-height:100dvh}
    .sidebar{width:264px;background:var(--panel);border-right:1px solid var(--border);position:sticky;top:0;align-self:flex-start;height:100dvh;overflow:auto}
    .content{flex:1;min-width:0}
    .sb-header{display:flex;align-items:center;gap:.75rem;padding:16px 18px;border-bottom:1px solid var(--border)}
    .sb-header img{height:36px;width:auto;display:block}
    .brand{font-weight:600;letter-spacing:.2px}
    nav.sb{display:flex;flex-direction:column;padding:10px}
    nav.sb a{color:var(--fg);text-decoration:none;padding:10px 12px;border-radius:10px;display:flex;align-items:center;gap:.6rem}
    nav.sb a:hover{background:#0b1226}
    nav.sb a.active{background:#0c1b31;outline:1px solid #16233f}
    .topbar{display:none;position:sticky;top:0;z-index:999;background:var(--panel);border-bottom:1px solid var(--border);padding:10px 14px;align-items:center;gap:10px}
    .hamburger{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:10px;padding:8px;cursor:pointer}
    .hamburger:focus{outline:2px solid #1e3a8a}
    .topbar .title{font-weight:600}
    .hero{position:relative;padding:40px 24px 20px;background:linear-gradient(180deg,rgba(24,37,67,.6),rgba(11,19,32,0));border-bottom:1px solid var(--border)}
    .hero-inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:16px}
    .hero h1{margin:0;font-size:28px}
    .hero p{margin:.25rem 0 0;color:var(--muted)}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px}

    /* Drawer */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:1000}
    .backdrop.show{opacity:1;pointer-events:auto}
    .drawer{position:fixed;inset:0;display:none;z-index:1000}
    .drawer.open{display:flex}
    .drawer .sidebar{transform:translateX(-100%);transition:transform .2s ease;position:relative;z-index:1001}
    .drawer.open .sidebar{transform:translateX(0)}

    @media (max-width: 900px){
      .app > .sidebar{display:none}
      .topbar{display:flex}
      .content{width:100%}
    }

    /* Faculty page UI */
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);color:#052}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--fg)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1220;border:1px solid var(--border);font-size:12px;color:var(--muted)}
    .hide{display:none}

    .action-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0 12px}
    .action-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .action-btn{display:flex;align-items:center;gap:14px;padding:16px 18px;background:var(--panel);border:1px solid var(--border);border-radius:14px;text-decoration:none;color:var(--fg);box-shadow:0 2px 8px rgba(0,0,0,.2)}
    .action-btn .icon{font-size:24px}
    .action-btn strong{font-weight:700}
    .action-btn em{font-style:normal;opacity:.75;font-size:.9rem}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:top}
    .table th{text-align:left}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar" aria-label="Primary">
      <div class="sb-header">
        <img src="/assets/branding/logo.png" alt="Pleural Seminar logo">
        <div class="brand">Pleural Seminar Wales 2025</div>
      </div>
      <nav class="sb" aria-label="Main navigation">
        <a href="index.html">Home</a>
        <a href="index.html#programme">Agenda</a>
        <a href="venue.html">Venue</a>
        <a href="posters.html">Posters</a>
        <a href="feedback.html">Feedback</a>
        <a href="faculty.html" class="active">Faculty</a>
        <a href="about.html">About</a>
      </nav>
    </aside>

    <div class="content">
      <div class="topbar">
        <button class="hamburger" id="openMenu" aria-label="Open menu" aria-controls="mobileDrawer" aria-expanded="false" type="button" onclick="window.__openDrawer && window.__openDrawer()">‚ò∞</button>
        <span class="title">Faculty</span>
      </div>

      <section class="hero" role="banner">
        <div class="hero-inner">
          <h1>Faculty Dashboard</h1>
          <p class="muted">Access tools and live data (protected)</p>
        </div>
      </section>

      <main class="container" id="main">
        <!-- Gate -->
        <div id="gate" class="card">
          <h2>Faculty access</h2>
          <p class="muted">Enter the faculty code to view live feedback and scoring tools.</p>
          <input id="code" type="password" placeholder="Access code" autocomplete="current-password" style="width:100%;background:#0b1220;border:1px solid var(--border);border-radius:10px;color:#fff;padding:10px 12px;">
          <div class="row">
            <button id="enter" class="btn primary">Enter</button>
            <span id="gateMsg" class="muted"></span>
          </div>
          <p class="muted" style="margin-top:8px;">This is a shared code for now; we can swap to Firebase Auth later.</p>
        </div>

        <!-- Dashboard -->
        <div id="dash" class="card hide">
          <div class="action-header">
            <div>
              <h2 style="margin:0">Welcome</h2>
              <p class="muted" style="margin:4px 0 0;">Pleural Seminar Wales 2025 ‚Ä¢ Live data from Firestore</p>
            </div>
            <span id="who" class="pill"></span>
          </div>

          <section aria-label="Faculty actions" style="margin:8px 0 18px;">
            <div class="action-grid">
              <a class="action-btn" href="posters-score.html" aria-label="Score posters"><span class="icon">üñºÔ∏è</span><span class="text"><strong>Score posters</strong><em>Judge poster submissions</em></span></a>
              <a class="action-btn" href="cases-score.html" aria-label="Score cases"><span class="icon">ü©∫</span><span class="text"><strong>Score cases</strong><em>Judge case presentations</em></span></a>
              <a class="action-btn" href="results.html" aria-label="View poster results"><span class="icon">üèÜ</span><span class="text"><strong>View poster results</strong><em>Live ranks & totals</em></span></a>
              <a class="action-btn" href="case-results.html" aria-label="View case results"><span class="icon">üèÜ</span><span class="text"><strong>View case results</strong><em>Live ranks & totals</em></span></a>
              <a class="action-btn" href="feedback-results.html" aria-label="View feedback"><span class="icon">üìä</span><span class="text"><strong>View feedback</strong><em>Charts & summaries</em></span></a>
            </div>
          </section>

          <h3 id="feedback">Feedback responses</h3>
          <div class="row">
            <button id="exportCsv" class="btn primary">Export CSV</button>
            <span class="muted" id="countLabel">0 responses</span>
          </div>

          <div style="overflow:auto;border:1px solid var(--border);border-radius:12px;">
            <table class="table" id="fbTable">
              <thead><tr><th>Submitted</th><th>Name</th><th>Email</th><th>Q1</th><th>Q2</th><th>Q3</th><th>...</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Mobile drawer -->
  <div class="drawer" id="mobileDrawer" aria-hidden="true" hidden>
    <aside class="sidebar" role="dialog" aria-label="Mobile menu">
      <div class="sb-header">
        <img src="/assets/branding/logo.png" alt="Pleural Seminar logo">
        <div class="brand">Pleural Seminar Wales 2025</div>
      </div>
      <nav class="sb" aria-label="Mobile navigation">
        <a href="index.html">Home</a>
        <a href="index.html#programme">Agenda</a>
        <a href="venue.html">Venue</a>
        <a href="posters.html">Posters</a>
        <a href="feedback.html">Feedback</a>
        <a href="faculty.html" class="active">Faculty</a>
        <a href="about.html">About</a>
      </nav>
    </aside>
    <div class="backdrop" id="backdrop"></div>
  </div>

  <!-- Drawer JS -->
  <script>
    (function(){
      const openBtn = document.getElementById('openMenu');
      const drawer = document.getElementById('mobileDrawer');
      const backdrop = document.getElementById('backdrop');
      if(!drawer || !backdrop){ return; }
      let lastFocus = null;
      function openDrawer(){ lastFocus=document.activeElement; drawer.hidden=false; drawer.classList.add('open'); document.body.style.overflow='hidden'; if(openBtn) openBtn.setAttribute('aria-expanded','true'); drawer.setAttribute('aria-hidden','false'); backdrop.classList.add('show'); }
      function closeDrawer(){ drawer.classList.remove('open'); backdrop.classList.remove('show'); document.body.style.overflow=''; if(openBtn) openBtn.setAttribute('aria-expanded','false'); drawer.setAttribute('aria-hidden','true'); setTimeout(()=>{ drawer.hidden=true; },200); if(lastFocus&&lastFocus.focus) lastFocus.focus(); }
      window.__openDrawer = openDrawer;
      openBtn?.addEventListener('click', openDrawer);
      openBtn?.addEventListener('touchstart', openDrawer, {passive:true});
      backdrop.addEventListener('click', closeDrawer);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });
      drawer.querySelectorAll('a').forEach(a=>{ a.addEventListener('click', ()=>{ closeDrawer(); }); });
    })();
  </script>

  <!-- Firebase (ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // TODO: replace ACCESS_CODE to your shared code
    const ACCESS_CODE = (localStorage.getItem('psw25_access_code')) || '';

    const firebaseConfig = {
      apiKey: "AIzaSyAZq933hFxLT1K49auoZjBnYWEdi2mKUFI",
      authDomain: "pleural-seminar-2025.firebaseapp.com",
      projectId: "pleural-seminar-2025",
      storageBucket: "pleural-seminar-2025.firebasestorage.app",
      messagingSenderId: "914784082205",
      appId: "1:914784082205:web:448e2d4fe8e9579075a9f4"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

    const gate = $('#gate');
    const dash = $('#dash');
    const code = $('#code');
    const enterBtn = $('#enter');
    const gateMsg = $('#gateMsg');
    const who = $('#who');

    function openDash(){ gate.classList.add('hide'); dash.classList.remove('hide'); who.textContent = 'Faculty'; }
    function deny(msg){ gateMsg.textContent = msg || 'Incorrect code'; gateMsg.style.color = '#f88'; }

    // If we already have a code saved, just show dash (you can tighten this later)
    if (ACCESS_CODE) openDash();

    enterBtn.addEventListener('click', ()=>{
      const val = (code.value||'').trim();
      if(!val){ deny('Enter the access code'); return; }
      // Basic client-side check only (replace with your own logic if needed)
      localStorage.setItem('psw25_access_code', val);
      openDash();
    });

    // Fetch feedback rows
    async function loadFeedback(){
      const tbody = $('#fbTable tbody');
      if(!tbody) return;
      try{
        const qRef = query(collection(db, 'feedback2025'), orderBy('submittedAt','desc'));
        const snap = await getDocs(qRef);
        $('#countLabel').textContent = `${snap.size} responses`;
        tbody.innerHTML = '';
        snap.forEach(doc=>{
          const r = doc.data();
          const tr = document.createElement('tr');
          const submitted = r.submittedAt?.toDate ? r.submittedAt.toDate().toLocaleString() : '';
          tr.innerHTML = `<td>${submitted||''}</td><td>${r.certificate_name||r.q19||''}</td><td>${r.email||r.q20||''}</td><td>${r.q1||''}</td><td>${r.q2||''}</td><td>${r.q3||''}</td><td>‚Ä¶</td>`;
          tbody.appendChild(tr);
        });
      }catch(e){ console.error(e); }
    }

    // CSV export
    function tableToCsv(table){
      const rows=[...table.querySelectorAll('tr')].map(tr=>[...tr.children].map(td=>`"${(td.textContent||'').replace(/"/g,'""')}"`).join(','));
      return rows.join('\n');
    }
    $('#exportCsv').addEventListener('click', ()=>{
      const csv = tableToCsv($('#fbTable'));
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'feedback_export.csv';
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    });

    // Kick off if dash is visible
    const observer = new MutationObserver(()=>{ if(!dash.classList.contains('hide')) loadFeedback(); });
    observer.observe(dash, {attributes:true});
  </script>
</body>
</html>
