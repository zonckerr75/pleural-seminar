<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Faculty — Pleural Seminar Wales 2025</title>
  <style>
:root{--bg:#0b1320;--panel:#0f172a;--fg:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--border:#1f2937}
/* Base */
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;padding-top:80px}
/* Fixed header */
header.nav{position:fixed;top:0;left:0;right:0;z-index:1000;background:#0b1320;border-bottom:1px solid var(--border);box-shadow:0 2px 10px rgba(0,0,0,.4)}
.wrap{max-width:1100px;margin:0 auto;padding:0 16px}
.nav-inner{display:flex;align-items:center;justify-content:space-between;min-height:64px}
.brand{display:flex;align-items:center;gap:10px}
.brand h1{font-size:20px;margin:0}
.brand .dot{width:6px;height:6px;border-radius:50%;background:#22c55e;display:inline-block}
.nav-list{list-style:none;margin:0;padding:0;display:flex;gap:18px;align-items:center}
.nav-list a{color:#e5e7eb;text-decoration:none;padding:10px 6px;display:inline-block}
.nav-list a:hover{text-decoration:underline}

.page{max-width:1100px;margin:0 auto;padding:24px}
.card{background:var(--panel);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
h1{margin:0 0 6px;font-size:26px}
h2{margin:14px 0 8px;font-size:20px}
.muted{color:var(--muted)}
.row{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
.btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn.primary{background:var(--accent);color:#052}
.btn.ghost{background:transparent;border:1px solid var(--border);color:var(--fg)}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
th,td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:top}
th{text-align:left;font-weight:700}
tr:hover td{background:#0c1526}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1220;border:1px solid var(--border);font-size:12px;color:var(--muted)}
.gate{max-width:420px;margin:60px auto}
input[type=password]{width:100%;background:#0b1220;border:1px solid var(--border);border-radius:10px;color:#fff;padding:10px 12px;margin:8px 0}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.spacer{flex:1}
.hide{display:none}
code{background:#0b1220;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  
<header class="nav">
  <div class="wrap nav-inner">
    <div class="brand">
      <span class="dot" aria-hidden="true"></span>
      <h1>Welsh Pleural Seminar 2025</h1>
    </div>
    <nav aria-label="Primary">
      <ul class="nav-list">
        <li><a href="/#programme">Agenda</a></li>
        <li><a href="/#house">Housekeeping</a></li>
        <li><a href="/#livestream">Livestream</a></li>
        <li><a href="/feedback.html">Feedback</a></li>
        <li><a href="/faculty.html" rel="nofollow">Faculty</a></li>
      </ul>
    </nav>
  </div>
</header>


  <div class="page">
    <div id="gate" class="card gate">
      <h2>Faculty access</h2>
      <p class="muted">Enter the faculty code to view live feedback and scoring tools.</p>
      <input id="code" type="password" placeholder="Access code" autocomplete="current-password" />
      <div class="row">
        <button id="enter" class="btn primary">Enter</button>
        <span id="gateMsg" class="muted"></span>
      </div>
      <p class="muted" style="margin-top:8px;">We’ll switch this to proper sign-in shortly (Firebase Auth). For now this is a shared code.</p>
    </div>

    <div id="dash" class="card hide">
      <h1>Faculty Dashboard</h1>
      <p class="muted">Pleural Seminar Wales 2025 • Live data from Firestore</p>

      <div class="row">
        <a href="#feedback" class="btn ghost">View feedback data</a>
        <a href="/posters.html" class="btn ghost">Score posters</a>
        <a href="/presentations.html" class="btn ghost">Score presentations</a>
        <span class="spacer"></span>
        <span id="who" class="pill"></span>
      </div>

      <h2 id="feedback">Feedback responses</h2>
      <div class="toolbar">
        <button id="exportCsv" class="btn primary">Export CSV</button>
        <span class="muted" id="countLabel">0 responses</span>
        <span class="spacer"></span>
        <label class="muted">Latest first</label>
      </div>

      <div style="overflow:auto">
        <table id="tbl">
          <thead>
            <tr>
              <th>When</th>
              <th>Name</th>
              <th>Email</th>
              <th>Q1</th>
              <th>Q2</th>
              <th>Q3</th>
              <th>Q4–Q14 (sessions)</th>
              <th>Q15 best</th>
              <th>Q16 worst</th>
              <th>Q17 impact</th>
              <th>Q18 comments</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <p class="muted" style="margin-top:10px">
        Tip: Use <code>Ctrl/Cmd + F</code> to search. CSV export includes all fields (Q1–Q20).
      </p>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
  <script>
    // -------- Robust faculty gate + single Firebase init --------
    const ACCESS_CODE = "pleural2025"; // change this if needed
    const firebaseConfig = {
      apiKey: "AIzaSyAZq933hFxLT1K49auoZjBnYWEdi2mKUFI",
      authDomain: "pleural-seminar-2025.firebaseapp.com",
      projectId: "pleural-seminar-2025",
      storageBucket: "pleural-seminar-2025.appspot.com",
      messagingSenderId: "914784082205",
      appId: "1:914784082205:web:448e2d4fe8e9579075a9f4"
    };

    // Initialise Firebase only once
    if (!firebase.apps || !firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    const gate = document.getElementById('gate');
    const dash = document.getElementById('dash');
    const enterBtn = document.getElementById('enter');
    const codeEl = document.getElementById('code');
    const msgEl = document.getElementById('gateMsg');
    const who = document.getElementById('who');

    function normalise(s){ return (s||"").toString().trim().replace(/\s+/g,''); }
    function openDash(){
      gate?.classList.add('hide');
      dash?.classList.remove('hide');
      if (who) who.textContent = "Faculty access granted";
      sessionStorage.setItem('psw25_gate','ok');
    }

    // If previously unlocked in this tab
    if (sessionStorage.getItem('psw25_gate') === 'ok') {
      openDash();
    } else {
      // Or unlock via URL ?code=... or #code=...
      const params = new URLSearchParams(location.search);
      const q = params.get('code');
      const hash = new URLSearchParams(location.hash.slice(1));
      const hq = hash.get('code');
      const urlCode = normalise(q || hq);
      if (urlCode && urlCode.toLowerCase() === normalise(ACCESS_CODE).toLowerCase()) {
        openDash();
      }
    }

    enterBtn?.addEventListener('click', () => {
      const val = normalise(codeEl?.value);
      if (!val) { msgEl.textContent = "Enter the access code."; return; }
      if (val.toLowerCase() !== normalise(ACCESS_CODE).toLowerCase()) {
        msgEl.textContent = "Incorrect code.";
        return;
      }
      msgEl.textContent = "";
      openDash();
      setTimeout(()=>document.getElementById('exportCsv')?.focus(), 50);
    });

    codeEl?.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') { e.preventDefault(); enterBtn?.click(); }
    });

    // ---- Feedback live view ----
    const tbody = document.querySelector('#tbl tbody');
    const countLabel = document.getElementById('countLabel');

    function fmtTime(ts){ if (!ts) return ""; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString(); }
    function renderRow(doc){
      const r = doc.data(); const res = r.responses || {};
      const sessions = []; for (let i=4;i<=14;i++) sessions.push(`${i}:${res['q'+i]||''}`);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${fmtTime(r.submittedAt)}</td>
        <td>${res.certificate_name || ""}</td>
        <td>${res.email || ""}</td>
        <td>${res.q1||""}</td>
        <td>${res.q2||""}</td>
        <td>${res.q3||""}</td>
        <td>${sessions.join(' · ')}</td>
        <td>${(res.q15||"").replaceAll("\n"," ")}</td>
        <td>${(res.q16||"").replaceAll("\n"," ")}</td>
        <td>${(res.q17||"").replaceAll("\n"," ")}</td>
        <td>${(res.q18||"").replaceAll("\n"," ")}</td>`;
      return tr;
    }

    let rowsData = [];
    db.collection('feedback').orderBy('submittedAt','desc')
      .onSnapshot(snap => {
        rowsData = []; tbody.innerHTML = "";
        snap.forEach(doc => { rowsData.push({ id: doc.id, ...doc.data() }); tbody.appendChild(renderRow(doc)); });
        countLabel.textContent = `${rowsData.length} response${rowsData.length===1?"":"s"}`;
      });

    function toCsvValue(v){ if (v == null) return ""; const s = String(v).replace(/"/g,'""'); return /[",\n]/.test(s) ? `"${s}"` : s; }
    function exportCsv(){ 
      const headers = ["docId","submittedAt","name","email","q1","q2","q3","q4","q5","q6","q7","q8","q9","q10","q11","q12","q13","q14","q15","q16","q17","q18"];
      const lines = [headers.join(",")];
      rowsData.forEach(d => {
        const res = d.responses || {};
        const row = [
          d.id,
          d.submittedAt?.toDate ? d.submittedAt.toDate().toISOString() : "",
          res.certificate_name||"",
          res.email||"",
          res.q1||"",res.q2||"",res.q3||"",
          res.q4||"",res.q5||"",res.q6||"",res.q7||"",res.q8||"",res.q9||"",res.q10||"",res.q11||"",res.q12||"",res.q13||"",res.q14||"",
          (res.q15||"").replaceAll("\n"," "),
          (res.q16||"").replaceAll("\n"," "),
          (res.q17||"").replaceAll("\n"," "),
          (res.q18||"").replaceAll("\n"," ")
        ].map(toCsvValue);
        lines.push(row.join(","));
      });
      const blob = new Blob([lines.join("\n")], {type: "text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = "feedback_export.csv";
      document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }
    document.getElementById('exportCsv')?.addEventListener('click', exportCsv);
  </script>
</body>
</html>
