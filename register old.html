<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pleural Seminar — Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b1320;--panel:#0f172a;--fg:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--border:#1f2937}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    .wrap{max-width:640px;margin:40px auto;padding:24px;background:var(--panel);border:1px solid var(--border);border-radius:16px}
    h1{margin:0 0 8px}
    p.muted{color:var(--muted);margin-top:0}
    label{display:block;margin:16px 0 6px}
    input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:#0b1426;color:var(--fg)}
    button, a.button{display:inline-block;text-decoration:none;padding:12px 16px;border:0;border-radius:12px;background:var(--accent);color:#03120a;font-weight:600;cursor:pointer}
    a.secondary{background:#1f2937;color:var(--fg);margin-left:8px}
    .row{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap}
    .msg{margin-top:16px;padding:12px;border-radius:12px;background:#0b1426;border:1px solid var(--border)}
    .ok{border-color:#164e2e}.warn{border-color:#7c2d12}.hidden{display:none}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // --- Firebase config for pleural-seminar-2025 (shared across pages) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAZq933hFxLT1K49auoZjBnYWEdi2mKUFI",
      authDomain: "pleural-seminar-2025.firebaseapp.com",
      projectId: "pleural-seminar-2025",
      storageBucket: "pleural-seminar-2025.appspot.com",
      messagingSenderId: "914784082205",
      appId: "1:914784082205:web:448e2d4fe8e9579075a9f4"
    };

    // --- Event settings ---
    const EVENT_ID   = "pleural-2025";
    const EVENT_DATE = "2025-11-14"; // 14 Nov 2025
    const USE_SUBCOL = true; // Option A: attendance/{date}/checkins/{token}

    // --- Helpers ---
    const el = id => document.getElementById(id);
    const P  = new URLSearchParams(location.search);
    const token = (P.get("token") || P.get("code") || "").trim();
    const decodeName = s => decodeURIComponent((s||"").replace(/\+/g," "));
    const nameFromUrl  = decodeName(P.get("n")||"");
    const emailFromUrl = (P.get("e")||"").trim();
    const isEmail = s => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s||"");
    const fmtTS = ts => { try { return new Date(ts.seconds*1000).toLocaleString("en-GB",{hour12:false}); } catch { return "—"; } };
    const feedbackHref = (n,e) => "feedback.html?" + new URLSearchParams({token,n,e}).toString();

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    function getRegRef(db, date, token){
      // attendance/{date}/checkins/{token}
      return doc(db, "attendance", date, "checkins", token);
    }

    async function init(){
      if(!token){
        el("content").classList.add("hidden");
        el("error").classList.remove("hidden");
        return;
      }

      el("welcomeName").textContent = nameFromUrl || "Attendee";
      if (nameFromUrl)  el("name").value  = nameFromUrl;
      if (emailFromUrl) el("email").value = emailFromUrl;

      // Prefill from attendees/{token}
      const attRef = doc(db,"attendees",token);
      try {
        const attSnap = await getDoc(attRef);
        if (attSnap.exists()){
          const d = attSnap.data() || {};
          if (!el("name").value && d.name)   el("name").value = d.name;
          if (!el("email").value && d.email) el("email").value = d.email;
          if (d.name) el("welcomeName").textContent = d.name;
        }
      } catch(e){ console.warn("attendees prefill failed:", e); }

      // Duplicate scan check
      const regRef = getRegRef(db, EVENT_DATE, token);
      try {
        const regSnap = await getDoc(regRef);
        if (regSnap.exists()){
          const d = regSnap.data() || {};
          el("already").classList.remove("hidden");
          el("prevTime").textContent = fmtTS(d.checkedInAt);
          el("feedbackBtn").href = feedbackHref(d.name || el("name").value || "", d.email || el("email").value || "");
        } else {
          el("feedbackBtn").href = feedbackHref(el("name").value||"", el("email").value||"");
        }
      } catch(e){ console.warn("attendance read failed:", e); }

      // Keep feedback link updated
      const sync = () => el("feedbackBtn").href = feedbackHref(el("name").value.trim(), el("email").value.trim());
      el("name").addEventListener("input", sync);
      el("email").addEventListener("input", sync);

      // Confirm handler
      el("btnConfirm").addEventListener("click", async ()=>{
        try {
          const name  = el("name").value.trim();
          const email = el("email").value.trim();

          if (!name){ el("msg").className="msg warn"; el("msg").textContent="Please confirm your name."; return; }
          if (!isEmail(email)){ el("msg").className="msg warn"; el("msg").textContent="Please enter a valid email address."; return; }

          // Upsert attendees/{token}
          const attRef = doc(db, "attendees", token);
          await setDoc(attRef, { name, email, updatedAt: serverTimestamp() }, { merge:true });

          // Create (or report existing) attendance/{date}/checkins/{token}
          const regRef = getRegRef(db, EVENT_DATE, token);
          const existing = await getDoc(regRef);

          if (existing.exists()){
            const d = existing.data() || {};
            const when = fmtTS(d.checkedInAt);
            el("already").style.display = "";
            el("prevTime").textContent = when;
            el("msg").className = "msg ok";
            el("msg").textContent = `Already checked in at ${when}.`;
          } else {
            await setDoc(regRef, { eventId: EVENT_ID, name, email, checkedInAt: serverTimestamp() });
            el("already").style.display = "none";
            el("msg").className = "msg ok";
            el("msg").textContent = "You’re checked in. Please provide feedback at the end by scanning your QR code again. You can download your attendance certificate from there.Enjoy the seminar!";
          }

          // Update feedback link with confirmed details
          el("feedbackBtn").href = feedbackHref(name,email);

        } catch(err){
          console.error(err);
          el("msg").className = "msg warn";
          el("msg").textContent = `Error: ${err.message || err}`;
        }
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  </script>
</head>
<body>
  <div class="wrap" id="content">
    <h1>Welcome, <span id="welcomeName">Attendee</span></h1>
    <p class="muted">Please confirm your details to complete check-in.</p>

    <label for="name">Name</label>
    <input id="name" type="text" placeholder="Your full name" />

    <label for="email">Email</label>
    <input id="email" type="email" placeholder="name@example.com" required />

    <div class="row">
      <button id="btnConfirm">Confirm Attendance</button>
      <a id="feedbackBtn" class="button secondary" href="#" role="button">Give Feedback</a>
    </div>

    <div id="msg" class="msg hidden"></div>

    <div id="already" class="msg" style="display:none">
      Duplicate scan — already checked in at: <strong id="prevTime">—</strong>
    </div>
  </div>

  <div class="wrap hidden" id="error">
    <h2>Badge token missing</h2>
    <p class="muted">Open this page by scanning your seminar badge QR code.</p>
  </div>
</body>
</html>
