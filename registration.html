<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pleural Seminar — Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b1320;--panel:#0f172a;--fg:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--border:#1f2937}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    .wrap{max-width:640px;margin:40px auto;padding:24px;background:var(--panel);border:1px solid var(--border);border-radius:16px}
    h1{margin:0 0 8px}
    p.muted{color:var(--muted);margin-top:0}
    label{display:block;margin:16px 0 6px}
    input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:#0b1426;color:var(--fg)}
    button, a.button{display:inline-block;text-decoration:none;padding:12px 16px;border:0;border-radius:12px;background:var(--accent);color:#03120a;font-weight:600;cursor:pointer}
    a.secondary{background:#1f2937;color:var(--fg);margin-left:8px}
    .row{display:flex;gap:8px;margin-top:16px;flex-wrap:wrap}
    .msg{margin-top:16px;padding:12px;border-radius:12px;background:#0b1426;border:1px solid var(--border)}
    .ok{border-color:#164e2e}
    .warn{border-color:#7c2d12}
    .hidden{display:none}
  </style>

  <!-- Firebase SDKs (v10+) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // -------------- CONFIG YOU MAY CHANGE --------------
    const firebaseConfig = {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
    };
    const EVENT_ID   = "pleural-2025";
    const EVENT_DATE = "2025-11-14"; // 14 Nov 2025
    // ---------------------------------------------------

    // Helpers
    function el(id){ return document.getElementById(id); }
    const params = new URLSearchParams(location.search);
    const token = (params.get("token") || params.get("code") || "").trim();
    const rawN  = params.get("n") || "";
    const rawE  = params.get("e") || "";
    const decodeName = s => decodeURIComponent(s.replace(/\+/g, " "));
    const nameFromUrl  = rawN ? decodeName(rawN) : "";
    const emailFromUrl = rawE || "";

    function isEmail(s){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s||""); }
    function fmtTS(dt){ try { return new Date(dt.seconds*1000).toLocaleString('en-GB',{hour12:false}); } catch { return "—"; } }
    function feedbackHref(n,e){
      const sp = new URLSearchParams({ token, n, e });
      return `feedback.html?${sp.toString()}`;
    }

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    async function loadPrefill(){
      if(!token){
        el("content").classList.add("hidden");
        el("error").classList.remove("hidden");
        return;
      }

      // Show welcome name early
      el("welcomeName").textContent = nameFromUrl || "Attendee";
      if (nameFromUrl) el("name").value = nameFromUrl;
      if (emailFromUrl) el("email").value = emailFromUrl;

      // If email missing, try Firestore attendees/{token}
      if (!el("email").value) {
        const attRef = doc(db, "attendees", token);
        const attSnap = await getDoc(attRef);
        if (attSnap.exists()) {
          const d = attSnap.data() || {};
          if (!el("name").value && d.name)  el("name").value = d.name;
          if (d.email)                      el("email").value = d.email;
          if (d.name || nameFromUrl)        el("welcomeName").textContent = d.name || nameFromUrl;
        }
      }

      // If already checked-in, show the previous timestamp
      const regRef = doc(db, "attendance", EVENT_DATE, token);
      const regSnap = await getDoc(regRef);
      if (regSnap.exists()) {
        const d = regSnap.data() || {};
        el("already").classList.remove("hidden");
        el("prevTime").textContent = fmtTS(d.checkedInAt);
        // Build feedback link
        el("feedbackBtn").href = feedbackHref(d.name || el("name").value || "", d.email || el("email").value || "");
      } else {
        // Build initial feedback link (updated again after confirm)
        el("feedbackBtn").href = feedbackHref(el("name").value||"", el("email").value||"");
      }
    }

    function syncFeedbackLink(){
      el("feedbackBtn").href = feedbackHref(el("name").value.trim(), el("email").value.trim());
    }

    async function confirmAttendance(){
      const name  = el("name").value.trim();
      const email = el("email").value.trim();

      if (!name) {
        el("msg").className = "msg warn";
        el("msg").textContent = "Please confirm your name.";
        return;
      }
      if (!isEmail(email)) {
        el("msg").className = "msg warn";
        el("msg").textContent = "Please enter a valid email address.";
        return;
      }

      // Upsert attendees/{token}
      await setDoc(doc(db, "attendees", token), {
        name, email, updatedAt: serverTimestamp()
      }, { merge: true });

      // Create attendance/{EVENT_DATE}/{token} if missing; else show previous time
      const regRef = doc(db, "attendance", EVENT_DATE, token);
      const cur = await getDoc(regRef);
      if (cur.exists()) {
        const d = cur.data() || {};
        el("already").classList.remove("hidden");
        el("prevTime").textContent = fmtTS(d.checkedInAt);
        el("msg").className = "msg ok";
        el("msg").textContent = `Already checked in at ${fmtTS(d.checkedInAt)}.`;
      } else {
        await setDoc(regRef, {
          eventId: EVENT_ID,
          name, email,
          checkedInAt: serverTimestamp()
        });
        el("already").classList.add("hidden");
        el("msg").className = "msg ok";
        el("msg").textContent = "You’re checked in. Enjoy the seminar!";
      }

      // Update feedback link with confirmed values
      syncFeedbackLink();
    }

    // Wire up
    window.addEventListener("DOMContentLoaded", async () => {
      await loadPrefill();
      el("name").addEventListener("input", syncFeedbackLink);
      el("email").addEventListener("input", syncFeedbackLink);
      el("confirm").addEventListener("click", confirmAttendance);
    });
  </script>
</head>
<body>
  <div class="wrap" id="content">
    <h1>Welcome, <span id="welcomeName">Attendee</span></h1>
    <p class="muted">Please confirm your details to complete check-in.</p>

    <label for="name">Name</label>
    <input id="name" type="text" placeholder="Your full name" />

    <label for="email">Email</label>
    <input id="email" type="email" placeholder="name@example.com" required />

    <div class="row">
      <button id="confirm">Confirm Attendance</button>
      <a id="feedbackBtn" class="button secondary" href="#" role="button">Give Feedback</a>
    </div>

    <div id="msg" class="msg hidden"></div>

    <div id="already" class="msg" style="display:none">
      Duplicate scan — already checked in at: <strong id="prevTime">—</strong>
    </div>
  </div>

  <div class="wrap hidden" id="error">
    <h2>Badge token missing</h2>
    <p class="muted">Open this page by scanning your seminar badge QR code.</p>
  </div>
</body>
</html>
