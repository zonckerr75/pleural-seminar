<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Feedback Results — Pleural Seminar Wales 2025</title>
  <link rel="stylesheet" href="style.css" />
<style>
  .free-text-list{
    list-style: disc;
    padding-left: 20px;
    margin: 8px 0 18px;
  }
  .free-text-list li{
    margin: 4px 0;
    color: var(--fg, #e5e7eb);
  }
</style>


</head>
<body>
  <header class="nav">
    <nav>
      <a href="index.html">Home</a>
      <a href="faculty.html">Faculty Dashboard</a>
      <span style="opacity:.6;">Feedback Results</span>
    </nav>
  </header>
<main style="padding:100px 20px;">
  <section id="analytics" class="panel" style="margin:24px 0;">
    <h2 style="margin:0 0 12px;">Feedback Analytics</h2>

    <!-- Controls -->
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px;">
      <label style="display:flex;align-items:center;gap:6px;">
        <input id="togglePercent" type="checkbox">
        Show as percentage
      </label>
      <span id="totalResponses" style="opacity:.8;"></span>
    </div>

    <!-- Top summary -->
    <div class="summary-grid">
      <div class="summary-card">
        <h4>Total responses</h4>
        <div class="value" id="sumTotal">—</div>
      </div>
      <div class="summary-card">
        <h4>Mean (Q1–Q3 overall)</h4>
        <div class="value" id="sumMeanCore">—</div>
      </div>
      <div class="summary-card">
        <h4>Mean (Sessions Q4–Q14)</h4>
        <div class="value" id="sumMeanSessions">—</div>
      </div>
    </div>

    <!-- Charts Q1–Q14 will be injected here -->
    <div id="chartsGrid" class="charts-grid"></div>

    <!-- Free-text Q15–Q18 -->
    <section style="margin-top:20px;">
      <h3 style="margin:16px 0 8px;" id="q15Title">Q15 — Best aspects (free text)</h3>
      <ul id="q15List" class="free-text-list"></ul>

      <h3 style="margin:16px 0 8px;" id="q16Title">Q16 — Areas to improve (free text)</h3>
      <ul id="q16List" class="free-text-list"></ul>

      <h3 style="margin:16px 0 8px;" id="q17Title">Q17 — Impact on practice (free text)</h3>
      <ul id="q17List" class="free-text-list"></ul>

      <h3 style="margin:16px 0 8px;" id="q18Title">Q18 — Any other comments (free text)</h3>
      <ul id="q18List" class="free-text-list"></ul>
    </section>
  </section>
</main>

  
// === Historic text → numeric score mapping (5 best → 1 worst) ===
const TEXT_TO_SCORE = {
  q1: {
    'extremely useful': 5,
    'useful': 4,
    'fairly useful': 3,
    'not useful': 2,
    'not relevant': 1
  },
  // Q2 & Q3 used "Excellent → Very poor"
  q2: {
    'excellent': 5,
    'good': 4,
    'fairly good': 3,
    'poor': 2,
    'very poor': 1
  },
  q3: {
    'excellent': 5,
    'good': 4,
    'fairly good': 3,
    'poor': 2,
    'very poor': 1
  }
};
// Sessions Q4–Q14 use the same scale as Q1
const GENERIC_USEFUL = TEXT_TO_SCORE.q1;

// Normalise any raw value (number or text) into a 1–5 score
function toScore(raw, qnum){
  if (raw == null) return NaN;
  if (typeof raw === 'number') return raw;
  // sometimes numeric strings like "4"
  const n = parseInt(raw, 10);
  if (Number.isFinite(n)) return n;

  const s = String(raw).trim().toLowerCase();
  if (!s) return NaN;

  if (qnum >= 4 && qnum <= 14) return GENERIC_USEFUL[s] ?? NaN;

  if (qnum === 1) return TEXT_TO_SCORE.q1[s] ?? NaN;
  if (qnum === 2) return TEXT_TO_SCORE.q2[s] ?? NaN;
  if (qnum === 3) return TEXT_TO_SCORE.q3[s] ?? NaN;

  return NaN;
}


  <script type="module" src="/scripts/feedback-results.js"></script>

<!-- Chart.js (bar charts) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- Firebase compat (match faculty.html) -->
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>

<script>
// ===== Config: set your real question texts here =====
// Replace the placeholder texts with your actual Q1–Q18 prompts.
// If a text is missing, the title will fall back to "Qn".
const QUESTION_TEXT = {
  q1: "Q1 — Overall quality",
  q2: "Q2 — Relevance to practice",
  q3: "Q3 — Organisation & timings",
  // Sessions (example placeholders)
  q4: "Q4 — Session 1",
  q5: "Q5 — Session 2",
  q6: "Q6 — Session 3",
  q7: "Q7 — Session 4",
  q8: "Q8 — Session 5",
  q9: "Q9 — Session 6",
  q10: "Q10 — Session 7",
  q11: "Q11 — Session 8",
  q12: "Q12 — Session 9",
  q13: "Q13 — Session 10",
  q14: "Q14 — Session 11",
  q15: "Q15 — Best aspects (free text)",
  q16: "Q16 — Areas to improve (free text)",
  q17: "Q17 — Impact on practice (free text)",
  q18: "Q18 — Any other comments (free text)"
};

// ===== Firebase init (same project as faculty.html) =====
const firebaseConfig = {
  apiKey: "AIzaSyAZq933hFxLT1K49auoZjBnYWEdi2mKUFI",
  authDomain: "pleural-seminar-2025.firebaseapp.com",
  projectId: "pleural-seminar-2025",
  storageBucket: "pleural-seminar-2025.appspot.com",
  messagingSenderId: "914784082205",
  appId: "1:914784082205:web:448e2d4fe8e9579075a9f4"
};
if (!firebase.apps || !firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ===== DOM hooks =====
const chartsGrid = document.getElementById('chartsGrid');
const togglePercent = document.getElementById('togglePercent');
const totalResponsesEl = document.getElementById('totalResponses');
const sumTotal = document.getElementById('sumTotal');
const sumMeanCore = document.getElementById('sumMeanCore');
const sumMeanSessions = document.getElementById('sumMeanSessions');

const q15List = document.getElementById('q15List');
const q16List = document.getElementById('q16List');
const q17List = document.getElementById('q17List');
const q18List = document.getElementById('q18List');

// Apply titles from QUESTION_TEXT onto headings already in the HTML (if present)
document.getElementById('q15Title') && (document.getElementById('q15Title').textContent = QUESTION_TEXT.q15 || "Q15");
document.getElementById('q16Title') && (document.getElementById('q16Title').textContent = QUESTION_TEXT.q16 || "Q16");
document.getElementById('q17Title') && (document.getElementById('q17Title').textContent = QUESTION_TEXT.q17 || "Q17");
document.getElementById('q18Title') && (document.getElementById('q18Title').textContent = QUESTION_TEXT.q18 || "Q18");

// ===== Build 14 individual chart cards (Q1..Q14) =====
const OPTION_LABELS = ["1","2","3","4","5"];
const barColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#22c55e';
const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border').trim() || '#1f2937';
const fgColor   = getComputedStyle(document.documentElement).getPropertyValue('--fg').trim()     || '#e5e7eb';

const chartRefs = []; // [{id, chart, metaEl, counts:[5]}]
chartsGrid.innerHTML = "";

for (let q=1; q<=14; q++){
  const id = `q${q}`;
  const card = document.createElement('div');
  card.className = 'chart-card';

  const h3 = document.createElement('h3');
  h3.textContent = QUESTION_TEXT[id] || id.toUpperCase();
  card.appendChild(h3);

  const meta = document.createElement('div');
  meta.className = 'chart-meta';
  meta.id = `meta-${id}`;
  meta.textContent = '—';
  card.appendChild(meta);

  const wrap = document.createElement('div');
  wrap.className = 'chart-wrap';
  const canvas = document.createElement('canvas');
  canvas.id = `chart-${id}`;
  wrap.appendChild(canvas);
  card.appendChild(wrap);

  chartsGrid.appendChild(card);

  const ctx = canvas.getContext('2d');
  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: OPTION_LABELS,
      datasets: [{
        label: 'Responses',
        data: [0,0,0,0,0],
        borderWidth: 1,
        backgroundColor: barColor
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (context) => {
              const v = context.parsed.y ?? 0;
              return togglePercent.checked ? `${v.toFixed(0)}%` : `${v} responses`;
            }
          }
        }
      },
      scales: {
        x: { grid: { color: gridColor }, ticks: { color: fgColor } },
        y: {
          beginAtZero: true,
          grid: { color: gridColor },
          ticks: { color: fgColor, precision: 0,
            callback: (val) => togglePercent.checked ? `${val}%` : val }
        }
      }
    }
  });

  chartRefs.push({ id, chart, metaEl: meta, counts: [0,0,0,0,0] });
}

// ===== Firestore stream → update charts + lists =====
let allRows = [];
db.collection('feedback').orderBy('submittedAt','desc').onSnapshot(snap => {
  allRows = [];
  // Reset counts
  chartRefs.forEach(ref => ref.counts = [0,0,0,0,0]);
  // Reset free text lists
  [q15List,q16List,q17List,q18List].forEach(ul => ul && (ul.innerHTML=""));

  snap.forEach(doc => {
    const d = doc.data() || {};
    const r = d.responses || {};
    allRows.push(r);

    // Tally Q1..Q14
    // Tally Q1..Q14
for (let q = 1; q <= 14; q++){
  const key = `q${q}`;
  const val = toScore(r[key], q);   // <-- use the helper
  if (Number.isFinite(val) && val >= 1 && val <= 5){
    chartRefs[q-1].counts[val-1] += 1;
  }
}


    // Append free text Q15..Q18 (skip empties)
    for (let q=15; q<=18; q++){
      const key = `q${q}`;
      const txt = (r[key] || "").toString().trim();
      if (!txt) continue;
      const li = document.createElement('li');
      li.textContent = txt.replace(/\s+/g, ' ');
      if (q === 15 && q15List) q15List.appendChild(li);
      else if (q === 16 && q16List) q16List.appendChild(li);
      else if (q === 17 && q17List) q17List.appendChild(li);
      else if (q === 18 && q18List) q18List.appendChild(li);
    }
  });

  // Update totals/means
  const N = allRows.length;
  totalResponsesEl.textContent = `Total responses: ${N}`;
  sumTotal && (sumTotal.textContent = String(N));

  // Mean of Q1–Q3 (overall core)
  const meanCore = meanFromRows(allRows, [1,2,3]);
  sumMeanCore && (sumMeanCore.textContent = isNaN(meanCore) ? "—" : meanCore.toFixed(2));

  // Mean across sessions Q4–Q14
  const meanSessions = meanFromRows(allRows, [4,5,6,7,8,9,10,11,12,13,14]);
  sumMeanSessions && (sumMeanSessions.textContent = isNaN(meanSessions) ? "—" : meanSessions.toFixed(2));

  renderCharts();
});

togglePercent.addEventListener('change', renderCharts);

function renderCharts(){
  chartRefs.forEach(ref => {
    const counts = ref.counts.slice();
    if (togglePercent.checked){
      const total = counts.reduce((a,b)=>a+b,0) || 1;
      ref.chart.data.datasets[0].data = counts.map(c => Math.round(c*100/total));
      ref.chart.options.scales.y.max = 100;
      ref.metaEl.textContent = `n=${total} • mean=${formatMeanFromCounts(counts)}`;
    } else {
      ref.chart.data.datasets[0].data = counts;
      const maxCount = Math.max(0, ...counts);
      ref.chart.options.scales.y.max = niceCeil(maxCount);
      ref.metaEl.textContent = `n=${counts.reduce((a,b)=>a+b,0)} • mean=${formatMeanFromCounts(counts)}`;
    }
    ref.chart.update();
  });
}

function formatMeanFromCounts(counts){
  const m = computeMeanFromCounts(counts);
  return isNaN(m) ? "—" : m.toFixed(2);
}
function computeMeanFromCounts(counts){
  const total = counts.reduce((a,b)=>a+b,0);
  if (!total) return NaN;
  const sum = counts.reduce((acc,c,idx)=> acc + c*(idx+1), 0);
  return sum / total;
}
function niceCeil(n){
  if (n <= 5) return 5;
  if (n <= 10) return 10;
  const pow = Math.pow(10, Math.floor(Math.log10(n)));
  const step = pow/2;
  return Math.ceil(n/step)*step;
}
function meanFromRows(rows, qnums){
  let sum=0, n=0;
  rows.forEach(r=>{
    qnums.forEach(q=>{
      const v = r[`q${q}`];
      const num = typeof v === 'string' ? parseInt(v,10) :
                  (typeof v === 'number' ? v : NaN);
      if (Number.isFinite(num) && num>=1 && num<=5){ sum += num; n++; }
    });
  });
  return n ? (sum/n) : NaN;
}
</script>

</body>
</html>
