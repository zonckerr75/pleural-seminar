<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Feedback Results — Pleural Seminar Wales 2025</title>

  <!-- THEME -->
  <style>
  :root{
    --bg:#0b1320; --panel:#0f172a; --fg:#e5e7eb; --muted:#94a3b8;
    --accent:#22c55e; --border:#1f2937;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);
       font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
       padding-top:80px}
  /* Fixed header (brand only, no breadcrumbs) */
  header.nav{position:fixed;top:0;left:0;right:0;z-index:1000;background:#0b1320;
             border-bottom:1px solid var(--border);box-shadow:0 2px 10px rgba(0,0,0,.4)}
  .wrap{max-width:1100px;margin:0 auto;padding:0 16px}
  .nav-inner{display:flex;align-items:center;justify-content:space-between;min-height:64px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand h1{font-size:20px;margin:0}
  .brand .dot{width:6px;height:6px;border-radius:50%;background:var(--accent);display:inline-block}

  .page-wrap{max-width:1100px;margin:0 auto;padding:24px}
  .card{background:var(--panel);border-radius:16px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .btn{padding:8px 14px;border-radius:10px;border:1px solid var(--border);color:var(--fg);
       background:transparent;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center}
  .btn:hover{border-color:var(--accent);color:var(--accent)}
  h1,h2,h3{color:var(--fg)}
  .muted{color:var(--muted)}

  /* Controls + grids */
  .charts-grid{display:grid;grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));gap:16px}
  .chart-card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
  .chart-card h3{margin:0 0 8px;font-size:14px;font-weight:600}
  .chart-meta{font-size:12px;opacity:.75;margin-bottom:6px}
  .chart-wrap{position:relative;height:220px}
  .free-text-list{list-style:disc;padding-left:20px;margin:8px 0 20px}

  /* Sticky header row inside card (title + back button) */
  .card-header{position:sticky;top:0;background:var(--panel);z-index:10;
               padding-bottom:8px;margin:-4px -4px 12px -4px}
  .card-header .bar{border-bottom:1px solid var(--border);padding:4px}
  </style>
</head>
<body>
  <header class="nav">
    <div class="wrap nav-inner">
      <div class="brand">
        <span class="dot" aria-hidden="true"></span>
        <h1>Welsh Pleural Seminar 2025</h1>
      </div>
      <!-- no menu/breadcrumbs -->
      <div></div>
    </div>
  </header>

  <main class="page-wrap">
    <div class="card">
      <div class="card-header">
        <div class="bar" style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
          <h1 style="margin:0;">Feedback Analytics</h1>
          <a href="/faculty.html" class="btn" aria-label="Back to Faculty Dashboard">← Back to Faculty Dashboard</a>
        </div>
      </div>

      <!-- Controls -->
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:4px 0 16px;">
        <label style="display:flex;align-items:center;gap:6px;">
          <input id="togglePercent" type="checkbox"> Show as percentage
        </label>
        <span id="totalResponses" class="muted"></span>
      </div>

      <!-- Charts Q1–Q14 -->
      <div id="chartsGrid" class="charts-grid"></div>

      <!-- Free text Q15–Q18 -->
      <section style="margin-top:28px;">
        <h2 style="margin:0 0 12px;">Free-text Feedback</h2>

        <h3 id="q15Title">Q15</h3>
        <ul id="q15List" class="free-text-list"></ul>

        <h3 id="q16Title">Q16</h3>
        <ul id="q16List" class="free-text-list"></ul>

        <h3 id="q17Title">Q17</h3>
        <ul id="q17List" class="free-text-list"></ul>

        <h3 id="q18Title">Q18</h3>
        <ul id="q18List" class="free-text-list"></ul>
      </section>
    </div>
  </main>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>

  <script>
  // ===== Load question text (JSON first, fallback to feedback.html parse) =====
  async function loadQuestionText(){
    try{
      const r = await fetch('/assets/feedback-questions.json',{cache:'no-store'});
      if(r.ok) return await r.json();
    }catch(e){}
    try{
      const r = await fetch('/feedback.html',{cache:'no-store'});
      if(r.ok){
        const html = await r.text();
        const doc = new DOMParser().parseFromString(html,'text/html');
        const out = {};
        doc.querySelectorAll('label, .question, [data-q]').forEach(el=>{
          const t=(el.getAttribute('data-q')||el.textContent||'').trim().replace(/\s+/g,' ');
          const m=/^Q([1-9]|1[0-8])\b/i.exec(t);
          if(m){ out['q'+m[1]] = t; }
        });
        return out;
      }
    }catch(e){}
    return {};
  }

  // ===== Historic text → numeric mapping =====
  const TEXT_TO_SCORE = {
    q1: {'extremely useful':5,'useful':4,'fairly useful':3,'not useful':2,'not relevant':1},
    q2: {'excellent':5,'good':4,'fairly good':3,'poor':2,'very poor':1},
    q3: {'excellent':5,'good':4,'fairly good':3,'poor':2,'very poor':1}
  };
  const GENERIC_USEFUL = TEXT_TO_SCORE.q1;
  function toScore(raw,qnum){
    if(raw==null) return NaN;
    if(typeof raw==='number') return raw;
    const n=parseInt(raw,10); if(Number.isFinite(n)) return n;
    const s=String(raw).trim().toLowerCase(); if(!s) return NaN;
    if(qnum>=4 && qnum<=14) return GENERIC_USEFUL[s] ?? NaN;
    if(qnum===1) return TEXT_TO_SCORE.q1[s] ?? NaN;
    if(qnum===2) return TEXT_TO_SCORE.q2[s] ?? NaN;
    if(qnum===3) return TEXT_TO_SCORE.q3[s] ?? NaN;
    return NaN;
  }

  // ===== Colors & DOM =====
  const barColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#22c55e';
  const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border').trim() || '#1f2937';
  const fgColor   = getComputedStyle(document.documentElement).getPropertyValue('--fg').trim()     || '#e5e7eb';

  const chartsGrid = document.getElementById('chartsGrid');
  const togglePercent = document.getElementById('togglePercent');
  const totalResponsesEl = document.getElementById('totalResponses');
  const q15List = document.getElementById('q15List');
  const q16List = document.getElementById('q16List');
  const q17List = document.getElementById('q17List');
  const q18List = document.getElementById('q18List');

  // ===== Firebase =====
  const firebaseConfig = {
    apiKey:"AIzaSyAZq933hFxLT1K49auoZjBnYWEdi2mKUFI",
    authDomain:"pleural-seminar-2025.firebaseapp.com",
    projectId:"pleural-seminar-2025",
    storageBucket:"pleural-seminar-2025.appspot.com",
    messagingSenderId:"914784082205",
    appId:"1:914784082205:web:448e2d4fe8e9579075a9f4"
  };
  if(!firebase.apps || !firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  (async function init(){
    const QT = await loadQuestionText();

    // Apply free-text titles
    const ids=[15,16,17,18];
    ids.forEach(i=>{
      const el=document.getElementById(`q${i}Title`);
      if(el && QT[`q${i}`]) el.textContent = QT[`q${i}`];
    });

    // Build Q1–Q14 chart cards
    const OPTION_LABELS = ["1","2","3","4","5"];
    const chartRefs = [];
    chartsGrid.innerHTML="";
    for(let q=1;q<=14;q++){
      const id=`q${q}`;
      const card=document.createElement('div'); card.className='chart-card';
      const h3=document.createElement('h3'); h3.textContent = QT[id] || id.toUpperCase(); card.appendChild(h3);
      const meta=document.createElement('div'); meta.className='chart-meta'; meta.id=`meta-${id}`; meta.textContent='—'; card.appendChild(meta);
      const wrap=document.createElement('div'); wrap.className='chart-wrap';
      const canvas=document.createElement('canvas'); canvas.id=`chart-${id}`; wrap.appendChild(canvas);
      card.appendChild(wrap); chartsGrid.appendChild(card);

      const ctx=canvas.getContext('2d');
      const chart=new Chart(ctx,{
        type:'bar',
        data:{labels:OPTION_LABELS,datasets:[{label:'Responses',data:[0,0,0,0,0],borderWidth:1,backgroundColor:barColor}]},
        options:{
          responsive:true,maintainAspectRatio:false,
          plugins:{legend:{display:false},tooltip:{callbacks:{label:(c)=>{const v=c.parsed.y??0; return togglePercent.checked?`${v.toFixed(0)}%`:`${v} responses`;}}}},
          scales:{x:{grid:{color:gridColor},ticks:{color:fgColor}},y:{beginAtZero:true,grid:{color:gridColor},ticks:{color:fgColor,precision:0,callback:(v)=>togglePercent.checked?`${v}%`:v}}}
        }
      });
      chartRefs.push({id,chart,metaEl:meta,counts:[0,0,0,0,0]});
    }

    // Stream data
    let allRows=[];
    db.collection('feedback').orderBy('submittedAt','desc').onSnapshot(snap=>{
      allRows=[]; chartRefs.forEach(r=>r.counts=[0,0,0,0,0]);
      [q15List,q16List,q17List,q18List].forEach(ul=>ul&&(ul.innerHTML=""));

      snap.forEach(doc=>{
        const d=doc.data()||{}; const r=d.responses||{}; allRows.push(r);
        // charts
        for(let q=1;q<=14;q++){
          const val = toScore(r[`q${q}`], q);
          if(Number.isFinite(val) && val>=1 && val<=5){ chartRefs[q-1].counts[val-1]+=1; }
        }
        // free text
        for(let q=15;q<=18;q++){
          const t=(r[`q${q}`]||"").toString().trim(); if(!t) continue;
          const li=document.createElement('li'); li.textContent=t.replace(/\s+/g,' ');
          if(q===15) q15List.appendChild(li); else if(q===16) q16List.appendChild(li);
          else if(q===17) q17List.appendChild(li); else if(q===18) q18List.appendChild(li);
        }
      });

      // top line count only (no summary cards)
      totalResponsesEl.textContent = `Total responses: ${allRows.length}`;

      renderCharts(chartRefs);
    });

    togglePercent.addEventListener('change',()=>renderCharts(chartRefs));
  })();

  function renderCharts(chartRefs){
    chartRefs.forEach(ref=>{
      const counts=ref.counts.slice();
      if(togglePercent.checked){
        const total=counts.reduce((a,b)=>a+b,0)||1;
        ref.chart.data.datasets[0].data=counts.map(c=>Math.round(c*100/total));
        ref.chart.options.scales.y.max=100;
        ref.metaEl.textContent=`n=${total} • mean=${formatMean(counts)}`;
      }else{
        ref.chart.data.datasets[0].data=counts;
        const max=Math.max(0,...counts);
        ref.chart.options.scales.y.max=niceCeil(max);
        ref.metaEl.textContent=`n=${counts.reduce((a,b)=>a+b,0)} • mean=${formatMean(counts)}`;
      }
      ref.chart.update();
    });
  }
  function formatMean(counts){
    const m=meanFromCounts(counts);
    return isNaN(m)?"—":m.toFixed(2);
  }
  function meanFromCounts(counts){
    const total=counts.reduce((a,b)=>a+b,0); if(!total) return NaN;
    const sum=counts.reduce((acc,c,i)=>acc+c*(i+1),0); return sum/total;
  }
  function niceCeil(n){
    if(n<=5) return 5; if(n<=10) return 10;
    const pow=Math.pow(10,Math.floor(Math.log10(n))); const step=pow/2;
    return Math.ceil(n/step)*step;
  }
  </script>
</body>
</html>
