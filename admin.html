<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pleural Seminar — Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b1320;--panel:#0f172a;--fg:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--border:#1f2937}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#0b1320bd;backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 20px}
    h1{margin:0 0 6px}
    .muted{color:var(--muted)}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin-top:16px}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .stat{background:#0b1426;border:1px solid var(--border);border-radius:14px;padding:14px}
    .stat .k{font-size:13px;color:var(--muted)}
    .stat .v{font-size:28px;font-weight:700;margin-top:2px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
    input[type="text"]{flex:1;min-width:240px;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1426;color:#e5e7eb}
    .btn{padding:10px 14px;border:0;border-radius:10px;background:var(--accent);color:#052e1b;font-weight:600;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
    .btn.secondary{background:#1f2937;color:#e5e7eb}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
    th{color:#cbd5e1;font-weight:600;position:sticky;top:98px;background:var(--panel);z-index:5}
    tr:hover td{background:#0b1426}
    .orgbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{font-size:12px;border:1px solid var(--border);background:#0b1426;border-radius:999px;padding:4px 8px}
    .error{margin-top:10px;padding:10px;border-radius:10px;background:#3b0d0d;border:1px solid #7f1d1d;color:#fecaca;display:none}
    footer{color:var(--muted);text-align:center;margin:24px 0}
    @media (max-width: 720px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Admin — Live Attendance</h1>
      <div class="muted">Pleural Seminar Wales · <span id="eventDate">2025-11-14</span></div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="grid">
        <div class="stat">
          <div class="k">Checked in</div>
          <div class="v" id="statCheckedIn">0</div>
        </div>
        <div class="stat">
          <div class="k">Unique emails</div>
          <div class="v" id="statEmails">0</div>
        </div>
        <div class="stat">
          <div class="k">Attendees in file</div>
          <div class="v" id="statTotal">—</div>
        </div>
      </div>

      <div id="err" class="error"></div>

      <div class="controls">
        <input id="search" type="text" placeholder="Search name, email, organisation…" />
        <a id="csv" class="btn secondary" href="#" download="attendance-2025-11-14.csv">Export (filtered)</a>
        <a id="csvAll" class="btn secondary" href="#" download="attendance-2025-11-14-all.csv">Export all (full date)</a>
        <a class="btn secondary" href="https://pleuralseminar.wales/faculty.html">Back to Faculty</a>
      </div>

      <div id="orgCounts" class="orgbar" aria-live="polite"></div>

      <table>
        <thead>
          <tr>
            <th style="width:35%">Name</th>
            <th style="width:35%">Email</th>
            <th style="width:30%">Organisation</th>
            <th style="width:15%">Checked in at</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="4" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <footer>© Pleural Seminar Wales 2025</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, collection, getDocs, onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAZq933hFxLT1K49auoZjBnYWEdi2mKUFI",
      authDomain: "pleural-seminar-2025.firebaseapp.com",
      projectId: "pleural-seminar-2025",
      storageBucket: "pleural-seminar-2025.appspot.com",
      messagingSenderId: "914784082205",
      appId: "1:914784082205:web:448e2d4fe8e9579075a9f4"
    };

    const EVENT_DATE = "2025-11-14";

    const $ = (id)=>document.getElementById(id);
    function showErr(msg){
      const el = $("err"); el.style.display="block"; el.textContent = msg;
      console.error(msg);
    }
    function normaliseOrg(s){
      const x = (s||"").trim().replace(/\s+/g, " ");
      return x ? x.replace(/\b\w/g, c => c.toUpperCase()) : "Unknown";
    }
    function csvEscape(val){
      const s = (val==null ? "" : String(val));
      const escaped = s.replace(/"/g, '""');
      return /[",\n]/.test(escaped) ? '"'+escaped+'"' : escaped;
    }
    function buildCsv(rows){
      const header = ["Name","Email","Organisation","Checked In At"];
      const body = rows.map(r => [r.name, r.email, r.organisation, r.when].map(csvEscape).join(","));
      return [header.map(csvEscape).join(",")].concat(body).join("\n");
    }
    function linkBlobToAnchor(text, anchorId, filename){
      const blob = new Blob([text], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = $(anchorId);
      a.href = url;
      a.download = filename;
    }
    function renderTable(list){
      const tbody = $("rows");
      tbody.innerHTML = "";
      if (!list.length){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 4; td.className = "muted"; td.textContent = "No check-ins yet.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      for (const r of list){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.name||"—"}</td>
          <td>${r.email||"—"}</td>
          <td>${r.organisation||"—"}</td>
          <td>${r.when||"—"}</td>
        `;
        tbody.appendChild(tr);
      }
    }
    function renderOrgCounts(list){
      const box = $("orgCounts");
      const freq = new Map();
      for (const r of list){
        const k = normaliseOrg(r.organisation);
        freq.set(k, (freq.get(k)||0)+1);
      }
      const items = [...freq.entries()].sort((a,b)=>b[1]-a[1]);
      box.innerHTML = items.map(([k,v])=>`<span class="chip">${k} — ${v}</span>`).join("") || "";
    }

    // Firebase init
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Data caches
    let liveRows = []; // rows currently from onSnapshot
    let filteredRows = []; // rows after search filter

    function applyFilter(){
      const q = $("search").value.trim().toLowerCase();
      filteredRows = q
        ? liveRows.filter(r =>
            (r.name||"").toLowerCase().includes(q) ||
            (r.email||"").toLowerCase().includes(q) ||
            (r.organisation||"").toLowerCase().includes(q)
          )
        : liveRows.slice();

      // Sort A→Z by name
      filteredRows.sort((a,b)=> (a.name||"").localeCompare(b.name||"", undefined, { sensitivity:"base" }));

      renderTable(filteredRows);
      renderOrgCounts(filteredRows);
      linkBlobToAnchor(buildCsv(filteredRows), "csv", "attendance-"+EVENT_DATE+".csv");
    }

    async function initDashboard(){
      try{
        $("eventDate").textContent = EVENT_DATE;

        // Preload attendees map for org enrichment (best effort)
        const attendees = new Map();
        try{
          const attSnap = await getDocs(collection(db, "attendees"));
          attSnap.forEach(d => {
            const v = d.data() || {};
            attendees.set(d.id, { name: v.name||"", email: v.email||"", organisation: v.organisation||"" });
          });
          $("statTotal").textContent = String(attSnap.size);
        } catch(e){
          $("statTotal").textContent = "—";
        }

        const col = collection(db, "attendance", EVENT_DATE, "checkins");
        onSnapshot(
          query(col, orderBy("checkedInAt","desc")),
          snap => {
            const seenEmails = new Set();
            liveRows = [];
            snap.forEach(docSnap => {
              const v = docSnap.data() || {};
              const token = docSnap.id;
              const fromAtt = attendees.get(token) || {};
              const name = v.name || fromAtt.name || "";
              const email = v.email || fromAtt.email || "";
              const organisation = fromAtt.organisation || v.organisation || "";
              const when = v.checkedInAt?.seconds
                ? new Date(v.checkedInAt.seconds*1000).toLocaleString("en-GB",{hour12:false})
                : (v.checkedInAt?.toDate ? v.checkedInAt.toDate().toLocaleString("en-GB",{hour12:false}) : "");

              if (email) seenEmails.add(email.toLowerCase());
              liveRows.push({ name, email, organisation, when });
            });

            $("statCheckedIn").textContent = String(liveRows.length);
            $("statEmails").textContent = String(seenEmails.size);

            applyFilter();
            linkBlobToAnchor(buildCsv(liveRows), "csvAll", "attendance-"+EVENT_DATE+"-all.csv");
          },
          err => showErr("Live read failed: " + err.message)
        );

        // Local filter without rebinding
        $("search").addEventListener("input", () => {
          applyFilter();
        });

      } catch(e){
        showErr("Initialisation error: " + e.message);
      }
    }

    initDashboard();
  </script>
</body>
</html>
