<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pleural Seminar — Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b1320;--panel:#0f172a;--fg:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--border:#1f2937}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#0b1320bd;backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 20px}
    h1{margin:0 0 6px}
    .muted{color:var(--muted)}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin-top:16px}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .stat{background:#0b1426;border:1px solid var(--border);border-radius:14px;padding:14px}
    .stat .k{font-size:13px;color:var(--muted)}
    .stat .v{font-size:28px;font-weight:700;margin-top:2px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
    input[type="text"]{flex:1;min-width:240px;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1426;color:#e5e7eb}
    button,.btn{padding:10px 14px;border:0;border-radius:10px;background:var(--accent);color:#052e1b;font-weight:600;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
    .btn.secondary{background:#1f2937;color:#e5e7eb}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
    th{color:#cbd5e1;font-weight:600;position:sticky;top:98px;background:var(--panel);z-index:5}
    tr:hover td{background:#0b1426}
    .orgbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{font-size:12px;border:1px solid var(--border);background:#0b1426;border-radius:999px;padding:4px 8px}
    footer{color:var(--muted);text-align:center;margin:24px 0}
    @media (max-width: 720px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Admin — Live Attendance</h1>
      <div class="muted">Pleural Seminar Wales · <span id="eventDate">2025-11-14</span></div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="grid">
        <div class="stat">
          <div class="k">Checked in</div>
          <div class="v" id="statCheckedIn">0</div>
        </div>
        <div class="stat">
          <div class="k">Unique emails</div>
          <div class="v" id="statEmails">0</div>
        </div>
        <div class="stat">
          <div class="k">Attendees in file</div>
          <div class="v" id="statTotal">—</div>
        </div>
      </div>

      <div class="controls">
        <input id="search" type="text" placeholder="Search name, email, organisation…" />
        <a id="csv" class="btn secondary" href="#" download="attendance-2025-11-14.csv">Export (filtered)</a>
        <a id="csvAll" class="btn secondary" href="#" download="attendance-2025-11-14-all.csv">Export all (full date)</a>
        <a class="btn secondary" href="https://pleuralseminar.wales/faculty.html">Back to Faculty</a>
      </div>

      <div id="orgCounts" class="orgbar" aria-live="polite"></div>

      <table>
        <thead>
          <tr>
            <th style="width:35%">Name</th>
            <th style="width:35%">Email</th>
            <th style="width:30%">Organisation</th>
            <th style="width:15%">Checked in at</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="4" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <footer>© Pleural Seminar Wales 2025</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, collection, getDocs, onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAZq933hFxLT1K49auoZjBnYWEdi2mKUFI",
      authDomain: "pleural-seminar-2025.firebaseapp.com",
      projectId: "pleural-seminar-2025",
      storageBucket: "pleural-seminar-2025.appspot.com",
      messagingSenderId: "914784082205",
      appId: "1:914784082205:web:448e2d4fe8e9579075a9f4"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Fixed event date
    const EVENT_DATE = "2025-11-14";

    const $ = (id)=>document.getElementById(id);

    // Helpers
    function debounce(fn, wait=200){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
    }

    function normaliseOrg(s){
      const x = (s||"").trim().replace(/\s+/g," ");
      return x ? x.replace(/\b\w/g, c=>c.toUpperCase()) : "Unknown";
    }

    function csvEscape(val){
      const s = (val==null ? "" : String(val));
      const escaped = s.replace(/"/g, '""');
      return /[",\n]/.test(escaped) ? '"'+escaped+'"' : escaped;
    }
    function buildCsv(rows){
      const header = ["Name","Email","Organisation","Checked In At"];
      const body = rows.map(r => [r.name, r.email, r.organisation, r.when].map(csvEscape).join(","));
      return [header.map(csvEscape).join(",")].concat(body).join("\n");
    }
    function linkBlobToAnchor(text, anchorId, filename){
      const blob = new Blob([text], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = $(anchorId);
      a.href = url;
      a.download = filename;
    }

    function renderTable(list){
      const tbody = $("rows");
      tbody.innerHTML = "";
      if (!list.length){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 4; td.className = "muted"; td.textContent = "No check-ins yet.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      for (const r of list){
        const tr = document.createElement("tr");
        tr.innerHTML = \`
          <td>\${r.name||"—"}</td>
          <td>\${r.email||"—"}</td>
          <td>\${r.organisation||"—"}</td>
          <td>\${r.when||"—"}</td>
        \`;
        tbody.appendChild(tr);
      }
    }

    function renderOrgCounts(list){
      const box = $("orgCounts");
      const freq = new Map();
      for (const r of list){
        const k = normaliseOrg(r.organisation);
        freq.set(k, (freq.get(k)||0)+1);
      }
      const items = [...freq.entries()].sort((a,b)=>b[1]-a[1]);
      box.innerHTML = items.map(([k,v])=>\`<span class="chip">\${k} — \${v}</span>\`).join("") || "";
    }

    // Cache attendees for org lookup
    let attendeesMap = null;
    async function loadAttendeesMap(){
      if (attendeesMap) return attendeesMap;
      const map = new Map();
      try{
        const snap = await getDocs(collection(db, "attendees"));
        snap.forEach(d => {
          const v = d.data() || {};
          map.set(d.id, {
            name: v.name || "",
            email: v.email || "",
            organisation: v.organisation || ""
          });
        });
      } catch(e){ console.warn("attendees map load failed:", e); }
      attendeesMap = map;
      return map;
    }

    // Live listener
    let unsubscribe = null;
    async function bindLive(){
      if (typeof unsubscribe === "function"){ unsubscribe(); unsubscribe = null; }

      $("eventDate").textContent = EVENT_DATE;
      linkBlobToAnchor("", "csv", "attendance-"+EVENT_DATE+".csv");
      linkBlobToAnchor("", "csvAll", "attendance-"+EVENT_DATE+"-all.csv");

      const attMap = await loadAttendeesMap();
      const col = collection(db, "attendance", EVENT_DATE, "checkins");
      const rows = [];
      const emails = new Set();

      unsubscribe = onSnapshot(query(col, orderBy("checkedInAt","desc")), snap => {
        rows.length = 0; emails.clear();
        snap.forEach(docSnap => {
          const v = docSnap.data() || {};
          const token = docSnap.id;
          const fromAtt = attMap.get(token) || {};
          const name = v.name || fromAtt.name || "";
          const email = v.email || fromAtt.email || "";
          const organisation = fromAtt.organisation || "";
          const when = v.checkedInAt?.seconds ? new Date(v.checkedInAt.seconds*1000).toLocaleString("en-GB",{hour12:false}) : "";
          rows.push({ name, email, organisation, when });
          if (email) emails.add(email.toLowerCase());
        });

        // Sort alphabetically by name
        rows.sort((a,b)=> (a.name||"").localeCompare(b.name||"", undefined, { sensitivity:"base" }));

        // Stats
        $("statCheckedIn").textContent = String(rows.length);
        $("statEmails").textContent = String(emails.size);

        const q = $("search").value.trim().toLowerCase();
        const filtered = q ? rows.filter(r =>
          (r.name||"").toLowerCase().includes(q) ||
          (r.email||"").toLowerCase().includes(q) ||
          (r.organisation||"").toLowerCase().includes(q)
        ) : rows;

        renderTable(filtered);
        renderOrgCounts(filtered);

        // CSV links
        linkBlobToAnchor(buildCsv(filtered), "csv", "attendance-"+EVENT_DATE+".csv");
        linkBlobToAnchor(buildCsv(rows), "csvAll", "attendance-"+EVENT_DATE+"-all.csv");
      });

      // Attendees total
      try{
        const all = await getDocs(collection(db,"attendees"));
        $("statTotal").textContent = String(all.size);
      } catch{
        $("statTotal").textContent = "—";
      }
    }

    (async function init(){
      await bindLive();
      const rerender = debounce(()=> bindLive(), 200);
      $("search").addEventListener("input", rerender);
    })();
  </script>
</body>
</html>
