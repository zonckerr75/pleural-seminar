<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pleural Seminar — Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b1320;--panel:#0f172a;--fg:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--border:#1f2937}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#0b1320bd;backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 20px}
    h1{margin:0 0 6px}
    .muted{color:var(--muted)}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin-top:16px}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .stat{background:#0b1426;border:1px solid var(--border);border-radius:14px;padding:14px}
    .stat .k{font-size:13px;color:var(--muted)}
    .stat .v{font-size:28px;font-weight:700;margin-top:2px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
    input[type="text"]{flex:1;min-width:220px;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1426;color:#e5e7eb}
    input[type="date"],select{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1426;color:#e5e7eb}
    button,.btn{padding:10px 14px;border:0;border-radius:10px;background:var(--accent);color:#052e1b;font-weight:600;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
    .btn.secondary{background:#1f2937;color:#e5e7eb}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
    th{color:#cbd5e1;font-weight:600;position:sticky;top:98px;background:var(--panel);z-index:5}
    tr:hover td{background:#0b1426}
    .right{justify-self:end}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1426;border:1px solid var(--border);font-size:12px}
    .orgbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{font-size:12px;border:1px solid var(--border);background:#0b1426;border-radius:999px;padding:4px 8px}
    footer{color:var(--muted);text-align:center;margin:24px 0}
    @media (max-width: 720px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Admin — Live Attendance</h1>
      <div class="muted">Pleural Seminar Wales · <span id="eventDate">2025-11-14</span></div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="grid">
        <div class="stat">
          <div class="k">Checked in</div>
          <div class="v" id="statCheckedIn">0</div>
        </div>
        <div class="stat">
          <div class="k">Unique emails</div>
          <div class="v" id="statEmails">0</div>
        </div>
        <div class="stat">
          <div class="k">Attendees in file</div>
          <div class="v" id="statTotal">—</div>
        </div>
      </div>

      <div class="controls">
        <input id="search" type="text" placeholder="Search name, email, organisation…" />
        <select id="filter">
          <option value="all">All</option>
          <option value="withEmail">With email</option>
          <option value="noEmail">No email</option>
        </select>
        <input id="date" type="date" />
        <button id="refresh">Refresh</button>
        <a id="csv" class="btn secondary" href="#" download="attendance-2025-11-14.csv">Export (filtered)</a>
        <a id="csvAll" class="btn secondary" href="#" download="attendance-2025-11-14-all.csv">Export all (full date)</a>
        <a class="btn secondary" href="https://pleuralseminar.wales/faculty.html">Back to Faculty</a>
      </div>

      <div id="orgCounts" class="orgbar" aria-live="polite"></div>

      <table>
        <thead>
          <tr>
            <th style="width:22%">Name</th>
            <th style="width:24%">Email</th>
            <th style="width:24%">Organisation</th>
            <th style="width:15%">Checked in at</th>
            <th style="width:15%">Token</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="5" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <footer>© Pleural Seminar Wales 2025</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // Firebase config (same as your current file)
    const firebaseConfig = {
      apiKey: "AIzaSyAZq933hFxLT1K49auoZjBnYWEdi2mKUFI",
      authDomain: "pleural-seminar-2025.firebaseapp.com",
      projectId: "pleural-seminar-2025",
      storageBucket: "pleural-seminar-2025.appspot.com",
      messagingSenderId: "914784082205",
      appId: "1:914784082205:web:448e2d4fe8e9579075a9f4"
    };

    // --- Helpers ---
    const $ = (id)=>document.getElementById(id);
    const qs = new URLSearchParams(location.search);
    const defaultDate = (qs.get("date") || "2025-11-14");

    // Debounce for search input
    function debounce(fn, wait=200){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
    }

    function normaliseOrg(s){
      const x = (s||"").trim().replace(/\s+/g," ");
      return x ? x.replace(/\b\w/g, c=>c.toUpperCase()) : "Unknown";
    }

    function toCsvRow(arr){
      return arr.map(v => {
        const s = (v==null?"":String(v)).replaceAll('"','""');
        return /[",\n]/.test(s) ? `"${s}"` : s;
      }).join(",");
    }

    function buildCsv(rows){
      const header = ["Name","Email","Organisation","Checked In At","Token"];
      const body = rows.map(r => toCsvRow([r.name, r.email, r.organisation, r.when, r.token]));
      return [toCsvRow(header)].concat(body).join("\n");
    }

    function linkBlobToAnchor(csvText, anchorId){
      const blob = new Blob([csvText], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = $(anchorId);
      a.href = url;
    }

    function renderTable(list){
      const tbody = $("rows");
      tbody.innerHTML = "";
      if (!list.length){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5; td.className = "muted"; td.textContent = "No check-ins yet.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      for (const r of list){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.name||"—"}</td>
          <td>${r.email||"—"}</td>
          <td>${r.organisation||"—"}</td>
          <td>${r.when||"—"}</td>
          <td><span class="pill">${r.token}</span></td>
        `;
        tbody.appendChild(tr);
      }
    }

    function renderOrgCounts(list){
      const box = $("orgCounts");
      const freq = new Map();
      for (const r of list){
        const k = normaliseOrg(r.organisation);
        freq.set(k, (freq.get(k)||0)+1);
      }
      const items = [...freq.entries()].sort((a,b)=>b[1]-a[1]);
      box.innerHTML = items.map(([k,v])=>`<span class="chip">${k} — ${v}</span>`).join("") || "";
    }

    function filterRows(rows){
      const q = $("search").value.trim().toLowerCase();
      const mode = $("filter").value;
      let out = rows;
      if (q){
        out = out.filter(r =>
          (r.name||"").toLowerCase().includes(q) ||
          (r.email||"").toLowerCase().includes(q) ||
          (r.organisation||"").toLowerCase().includes(q) ||
          (r.token||"").toLowerCase().includes(q)
        );
      }
      if (mode === "withEmail"){ out = out.filter(r => (r.email||"") !== ""); }
      if (mode === "noEmail"){ out = out.filter(r => !r.email); }
      return out;
    }

    // --- App ---
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // We keep the attendees map cached across date changes
    let attendeesMap = null;

    async function loadAttendeesMap(){
      if (attendeesMap) return attendeesMap;
      const map = new Map();
      try{
        const snap = await getDocs(collection(db, "attendees"));
        snap.forEach(d => {
          const v = d.data() || {};
          map.set(d.id, { name: v.name || "", email: v.email || "", organisation: v.organisation || "" });
        });
      } catch(e){ console.warn("attendees map load failed:", e); }
      attendeesMap = map;
      return map;
    }

    // Live listener management per date
    let unsubscribe = null;
    let currentDate = defaultDate;

    function setDateUI(d){
      $("eventDate").textContent = d;
      $("date").value = d;
      $("csv").download = `attendance-${d}.csv`;
      $("csvAll").download = `attendance-${d}-all.csv`;
    }

    async function bindDateListener(d){
      // Unsubscribe previous date stream
      if (typeof unsubscribe === "function"){ unsubscribe(); unsubscribe = null; }

      currentDate = d;
      setDateUI(d);

      const attMap = await loadAttendeesMap();
      const col = collection(db, "attendance", d, "checkins");
      const rows = [];
      const emails = new Set();

      unsubscribe = onSnapshot(query(col, orderBy("checkedInAt","desc")), snap => {
        rows.length = 0; emails.clear();
        snap.forEach(docSnap => {
          const v = docSnap.data() || {};
          const token = docSnap.id;
          const a = attMap.get(token) || {};
          const name = v.name || a.name || "";
          const email = v.email || a.email || "";
          const organisation = a.organisation || "";
          const when = v.checkedInAt?.seconds ? new Date(v.checkedInAt.seconds*1000).toLocaleString("en-GB",{hour12:false}) : "";
          rows.push({ token, name, email, organisation, when });
          if (email) emails.add(email.toLowerCase());
        });

        // stats
        $("statCheckedIn").textContent = String(rows.length);
        $("statEmails").textContent = String(emails.size);

        // filtered render + CSV (filtered)
        const filtered = filterRows(rows);
        renderTable(filtered);
        renderOrgCounts(filtered);
        linkBlobToAnchor(buildCsv(filtered), "csv");

        // prepare "Export all" CSV
        linkBlobToAnchor(buildCsv(rows), "csvAll");
      });

      // total from attendees collection (unchanged behaviour)
      try{
        const all = await getDocs(collection(db,"attendees"));
        $("statTotal").textContent = String(all.size);
      } catch{
        $("statTotal").textContent = "—";
      }
    }

    // Init
    (async function init(){
      setDateUI(defaultDate);
      await bindDateListener(defaultDate);

      // Wire controls
      $("refresh").addEventListener("click", ()=> bindDateListener(currentDate));

      const rerender = debounce(()=> {
        // Force the onSnapshot callback to recompute filtered view by toggling tiny no-op:
        // Instead, we’ll just rebuild from current anchors (we already rebuild inside snapshot).
        // Here, trigger CSV rebuild by calling bindDateListener without re-subscribing:
        // Simpler: change a dummy hash to prompt the onSnapshot callback on next doc change.
        // Practically, we re-run filter/render using cached arrays would need ref; to keep code small,
        // just click "Refresh" if you need immediate recompute between snapshot ticks.
        // To keep it deterministic, rebind snapshot (cheap for small collections).
        bindDateListener(currentDate);
      }, 200);

      $("search").addEventListener("input", rerender);
      $("filter").addEventListener("change", rerender);

      $("date").addEventListener("change", (e)=>{
        const d = e.target.value || defaultDate;
        bindDateListener(d);
        // keep the date in URL for bookmarking
        const url = new URL(location.href);
        url.searchParams.set("date", d);
        history.replaceState(null, "", url.toString());
      });
    })();
  </script>
</body>
</html>
