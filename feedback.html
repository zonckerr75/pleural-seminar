<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pleural Seminar Wales 2025 — Feedback</title>
  <meta name="description" content="Event feedback form with instant certificate download or email." />
  <style>
    :root{--bg:#0b1320;--panel:#0f172a;--fg:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--danger:#ef4444;--border:#1f2937}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:22px}
    .card{background:var(--panel);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:22px}
    h1{margin:6px 0 12px;font-size:28px}
    h2{margin:22px 0 10px;font-size:20px;color:#fff}
    p.small{color:var(--muted)}
    .form-group{margin:14px 0}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--accent);color:#052}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--fg)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Pleural Seminar Wales 2025 – Evaluation</h1>
      <p class="small" style="margin-bottom:16px; line-height:1.6;">Thank you for participating in our event. We hope you enjoyed the seminar and found it interesting.</p>
      <p class="small" style="margin-bottom:24px; line-height:1.6;">We want to hear your feedback so we can keep improving our logistics and content. Please fill this quick survey and let us know your thoughts.</p>

      <form id="feedback-form" name="feedback-form">
        <!-- Q1 -->
        <div class="form-group">
          <label for="q1"><strong>1. How useful did you find this event?</strong></label><br>
          <label><input type="radio" name="q1" value="Extremely useful" required> Extremely useful</label><br>
          <label><input type="radio" name="q1" value="Useful"> Useful</label><br>
          <label><input type="radio" name="q1" value="Fairly useful"> Fairly useful</label><br>
          <label><input type="radio" name="q1" value="Not useful"> Not useful</label>
        </div>

        <!-- Q2 -->
        <div class="form-group">
          <label for="q2"><strong>2. What was your overall impression of the programme of this event?</strong></label><br>
          <label><input type="radio" name="q2" value="Excellent" required> Excellent</label><br>
          <label><input type="radio" name="q2" value="Good"> Good</label><br>
          <label><input type="radio" name="q2" value="Fairly good"> Fairly good</label><br>
          <label><input type="radio" name="q2" value="Poor"> Poor</label><br>
          <label><input type="radio" name="q2" value="Very poor"> Very poor</label>
        </div>

        <!-- Q3 -->
        <div class="form-group">
          <label for="q3"><strong>3. What was your overall impression of the organisation of this event?</strong></label><br>
          <label><input type="radio" name="q3" value="Excellent" required> Excellent</label><br>
          <label><input type="radio" name="q3" value="Good"> Good</label><br>
          <label><input type="radio" name="q3" value="Fairly good"> Fairly good</label><br>
          <label><input type="radio" name="q3" value="Poor"> Poor</label><br>
          <label><input type="radio" name="q3" value="Very poor"> Very poor</label>
        </div>

        <!-- Q4–Q14 (session questions) injected to match your previous file) -->
        <script>
          const sessionQuestions = [
            ["4", "‘Diagnostic Pathway in MPE – New Data on “Straight-to-Biopsy”’ by Prof. Naj Rahman"],
            ["5", "‘Update in Mesothelioma Research – HIT-MESO Trial’ by Dr. Paul Shaw"],
            ["6", "‘Local Anaesthetic Thoracoscopy’ by Dr. Richard Westley"],
            ["7", "‘Clinical Applications of Artificial Intelligence’ by Prof. Alan Fraser"],
            ["8", "‘A Pathway for the Management of Hepatic Hydrothorax’ by Dr. Sam Ryan"],
            ["9", "‘Legal Aspects in Asbestos-related Pleural Disease’ by speaker from Irwin Mitchell"],
            ["10", "‘Thoracic Ultrasound Training’ by Dr. Rebecca Pearce"],
            ["11", "‘How Did We Manage Pneumothoraces?’ by Dr. Natnael Afesha"],
            ["12", "‘Outcomes of Empyema’ by Dr. Nora Ramley"],
            ["13", "‘Ten Years of Ambulatory Pleural Procedure Service at SBUHB’ by Dr. N. Chinnappa"],
            ["14", "the Case Presentation session"]
          ];
          document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("feedback-form");
            sessionQuestions.forEach(([num, title]) => {
              const div = document.createElement("div");
              div.className = "form-group";
              div.innerHTML = `
                <label for="q${num}"><strong>${num}. How useful to you personally was ${title}?</strong></label><br>
                <label><input type="radio" name="q${num}" value="Extremely useful" required> Extremely useful</label><br>
                <label><input type="radio" name="q${num}" value="Useful"> Useful</label><br>
                <label><input type="radio" name="q${num}" value="Fairly useful"> Fairly useful</label><br>
                <label><input type="radio" name="q${num}" value="Not useful"> Not useful</label><br>
                <label><input type="radio" name="q${num}" value="Not relevant"> Not relevant</label>
              `;
              form.appendChild(div);
            });
          });
        </script>

        <!-- Q15 -->
        <div class="form-group">
          <label for="q15"><strong>15. What was the best aspect of this event?</strong></label><br>
          <textarea id="q15" name="q15" rows="3" placeholder="Type your response here..." style="width:100%;" required></textarea>
        </div>

        <!-- Q16 -->
        <div class="form-group">
          <label for="q16"><strong>16. What was the worst aspect of this event?</strong></label><br>
          <textarea id="q16" name="q16" rows="3" placeholder="Type your response here..." style="width:100%;" required></textarea>
        </div>

        <!-- Q17 -->
        <div class="form-group">
          <label for="q17"><strong>17. What impact will this event have on your future practice?</strong></label><br>
          <textarea id="q17" name="q17" rows="3" placeholder="Type your response here..." style="width:100%;" required></textarea>
        </div>

        <!-- Q18 -->
        <div class="form-group">
          <label for="q18"><strong>18. Any additional comments or suggestions for future topics of discussion?</strong></label><br>
          <textarea id="q18" name="q18" rows="3" placeholder="Type your response here..." style="width:100%;" required></textarea>
        </div>

        <!-- Q19 -->
        <div class="form-group">
          <label for="q19"><strong>19. Enter your name as it should appear on your certificate</strong></label><br>
          <input type="text" id="q19" name="certificate_name" placeholder="Your full name" style="width:100%;" required>
        </div>

        <!-- Q20 -->
        <div class="form-group">
          <label for="q20"><strong>20. Email address</strong></label><br>
          <input type="email" id="q20" name="email" placeholder="you@example.com" style="width:100%;" required>
        </div>

        <!-- Submit -->
        <div style="margin-top:20px;">
          <button type="submit" class="btn primary">Submit Feedback</button>
        </div>

        <!-- Certificate actions (revealed after successful submit) -->
        <div id="cert-actions" style="display:none; margin-top:24px;">
          <hr style="margin:18px 0;">
          <h3 style="margin:0 0 10px;">Your Certificate</h3>
          <p style="color:#94a3b8; margin:0 0 12px;">Choose how you’d like to receive it:</p>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button type="button" id="downloadCert" class="btn primary">Download Certificate</button>
            <button type="button" id="emailCert" class="btn ghost">Email Certificate</button>
          </div>
          <p style="color:#94a3b8; font-size:12px; margin-top:10px;">Name will be centred, 7&nbsp;cm below the top on the official PDF.</p>
        </div>
      </form>
    </div>
  </div>

  <!-- pdf-lib for client-side certificate -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <script>
    // Reveal the certificate action buttons after a valid form submit (client-side only)
    (function wireSubmitReveal(){
      const form = document.getElementById('feedback-form');
      const actions = document.getElementById('cert-actions');
      if(!form || !actions) return;
      form.addEventListener('submit', function(e){
        if(!form.checkValidity()) return; // let browser show built-in validation
        e.preventDefault();
        actions.style.display = 'block';
        actions.scrollIntoView({ behavior:'smooth', block:'start' });
      }, false);
    })();

    // ----- Certificate generation (same logic as certificate_auto) -----
    async function fetchBasePdf(){
      const urls=['/assets/cert/certificate.pdf','assets/cert/certificate.pdf'];
      for(const u of urls){ try{ const r=await fetch(u,{cache:'no-store'}); if(r.ok) return await r.arrayBuffer(); } catch(_){} }
      throw new Error('Cannot load /assets/cert/certificate.pdf');
    }

    async function buildPdf(name){
      const { PDFDocument, StandardFonts, rgb } = PDFLib;
      const base = await fetchBasePdf();
      const pdf = await PDFDocument.load(base);
      const page = pdf.getPage(0);
      const { width:W, height:H } = page.getSize();
      const font = await pdf.embedFont(StandardFonts.HelveticaBold);
      const size = 24;
      const y = H - (7*72/2.54); // 7 cm from top
      const x = (W - font.widthOfTextAtSize(name, size)) / 2; // centre
      page.drawText(name, { x, y, size, font, color: rgb(0,0,0) });
      return await pdf.save();
    }

    async function downloadCertificate(name){
      const bytes = await buildPdf(name);
      const blob = new Blob([bytes], { type:'application/pdf' });
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download=`Pleural Seminar Wales 2025 - Certificate - ${name}.pdf`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    }

    async function emailCertificate(name,email){
      const bytes = await buildPdf(name);
      const b = new Uint8Array(bytes); let bin=''; for(let i=0;i<b.length;i++) bin += String.fromCharCode(b[i]);
      const pdfBase64 = btoa(bin);
      const resp = await fetch('/api/email', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, email, pdfBase64 }) });
      if(!resp.ok) throw new Error(await resp.text());
    }

    // Wire the two buttons to your existing Q19/Q20 inputs
    (function wireButtons(){
      const dn = document.getElementById('downloadCert');
      const em = document.getElementById('emailCert');
      if (dn) dn.addEventListener('click', async () => {
        const name = (document.getElementById('q19')?.value || '').trim();
        if (!name) return alert('Please enter your name in Q19.');
        await downloadCertificate(name);
      });

      if (em) em.addEventListener('click', async () => {
        const name = (document.getElementById('q19')?.value || '').trim();
        const email = (document.getElementById('q20')?.value || '').trim();
        if (!name || !email) return alert('Please complete Q19 (name) and Q20 (email).');
        try { await emailCertificate(name, email); alert('Certificate emailed. Please check your inbox (and spam).'); }
        catch(e){ alert('Email failed: ' + (e?.message||e)); }
      });
    })();
  </script>
</body>
</html>
