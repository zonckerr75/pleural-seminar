<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Posters — Pleural Seminar Wales 2025</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{
      --bg:#0b1320;--panel:#0f172a;--fg:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--border:#1f2937
    }
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      display:flex;min-height:100vh
    }
    /* Optional sidebar placeholder; replace with your site's sidebar include */
    aside.nav{
      width:260px;background:var(--panel);border-right:1px solid var(--border);
      position:sticky;top:0;height:100vh;padding:20px;display:none
    }
    @media (min-width: 1024px){ aside.nav{display:block} }
    main{flex:1;min-width:0;padding:24px}
    header.page{display:flex;flex-direction:column;gap:6px;margin-bottom:18px}
    header.page h1{font-size:24px;margin:0}
    header.page p{color:var(--muted);margin:0}

    /* Grid */
    .grid{
      display:grid;gap:16px;
      grid-template-columns: repeat(1, minmax(0, 1fr));
    }
    @media (min-width: 640px){ .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (min-width: 1024px){ .grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }

    /* Card */
    .card{
      background:var(--panel);border:1px solid var(--border);border-radius:16px;
      overflow:hidden;display:flex;flex-direction:column;min-height:260px
    }
    .thumb{
      aspect-ratio:3/4;display:flex;align-items:center;justify-content:center;
      border-bottom:1px solid var(--border);position:relative
    }
    .thumb object,.thumb canvas{width:100%;height:100%;display:block}
    .thumb .fallback{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      font-weight:700;letter-spacing:0.08em;color:var(--muted)
    }
    .info{padding:12px}
    .title{font-weight:600;margin:0 0 6px 0}
    .meta{color:var(--muted);font-size:14px;margin:0}
    .open{
      text-decoration:none;color:var(--fg);display:block
    }
    .open:focus-visible{outline:2px solid var(--accent);outline-offset:4px;border-radius:12px}
    .badge{
      position:absolute;top:8px;left:8px;background:rgba(34,197,94,.15);color:#86efac;
      font-weight:600;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(134,239,172,.3)
    }
  </style>
</head>
<body>
  <!-- Optional sidebar placeholder; keep or remove per your layout -->
  <aside class="nav">
    <h3 style="margin-top:0">Pleural Seminar</h3>
    <nav>
      <a href="index.html" style="display:block;color:var(--fg);margin:8px 0">Home</a>
      <a href="venue.html" style="display:block;color:var(--fg);margin:8px 0">Venue</a>
      <a href="faculty.html" style="display:block;color:var(--fg);margin:8px 0">Faculty</a>
      <a href="feedback.html" style="display:block;color:var(--fg);margin:8px 0">Feedback</a>
      <a href="about.html" style="display:block;color:var(--fg);margin:8px 0">About</a>
      <span style="display:block;color:var(--muted);margin:8px 0">Posters</span>
    </nav>
  </aside>

  <main>
    <header class="page">
      <h1>Posters</h1>
      <p>Click a thumbnail to open the full PDF in a new tab.</p>
      <p style="display:none" id="csvStatus"></p>
    </header>

    <section class="grid" id="posterGrid" aria-live="polite"></section>
  </main>

  <!-- PDF.js for MOBILE-ONLY thumbnail rendering -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <script>
    // Configure worker
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";
    }
  </script>

  <script>
  (function(){
    const grid = document.getElementById('posterGrid');
    const csvStatus = document.getElementById('csvStatus');

    // === CONFIG ===
    const PREFIX = 'assets/posters/'; // NOTE: no leading slash
    const STEM = 'P';
    const MAX = 99;
    const PAD = n => n.toString().padStart(2,'0');
    const MAX_CONSEC_MISSES = 15;

    // Optional CSV mapping (id,title,authors)
    const CSV_URL = PREFIX + 'posters.csv';

    // Inline fallback mapping
    const TITLE_MAP = {
      // 'P01': { title: 'Example', authors: 'A Smith; B Jones' },
    };

    // --- Environment detection ---
    const ua = navigator.userAgent || "";
    const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
    const isAndroid = /Android/.test(ua);
    const isSmallScreen = window.matchMedia && window.matchMedia("(max-width: 767px)").matches;
    // Many mobile browsers don't render <object type="application/pdf"> reliably.
    const preferCanvas = (isIOS || isAndroid || isSmallScreen) && !!window.pdfjsLib;

    // --- Utilities ---
    function parseCSV(text){
      const out = {};
      const lines = text.split(/[\r\n]+/).map(l => l.trim()).filter(Boolean);
      for (const line of lines){
        if (/^id\s*,/i.test(line)) continue; // skip header
        const parts = line.split(',').map(s => s.trim());
        if (parts.length >= 3){
          const id = parts[0];
          const title = parts[1];
          const authors = parts.slice(2).join(', ');
          out[id] = { title, authors };
        }
      }
      return out;
    }

    async function loadCSVMap(){
      try{
        const res = await fetch(CSV_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('CSV not found');
        const text = await res.text();
        const map = parseCSV(text);
        if (Object.keys(map).length){
          csvStatus.textContent = 'Loaded titles from posters.csv';
          csvStatus.style.display = 'none';
          return map;
        }
        throw new Error('CSV empty');
      }catch(e){
        return TITLE_MAP;
      }
    }

    function makeCardShell(id, url, meta){
      const a = document.createElement('a');
      a.href = url; a.target = '_blank'; a.rel = 'noopener';
      a.className = 'open';

      const card = document.createElement('article');
      card.className = 'card';

      const thumb = document.createElement('div');
      thumb.className = 'thumb';

      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.textContent = id;

      const fb = document.createElement('div');
      fb.className = 'fallback';
      fb.textContent = 'PDF';

      thumb.appendChild(badge);
      thumb.appendChild(fb);

      const info = document.createElement('div');
      info.className = 'info';
      const title = document.createElement('h3'); title.className = 'title';
      title.textContent = meta?.title || id;
      const metaP = document.createElement('p'); metaP.className = 'meta';
      metaP.textContent = meta?.authors ? meta.authors : 'Click to open';

      info.appendChild(title); info.appendChild(metaP);
      card.appendChild(thumb); card.appendChild(info); a.appendChild(card);
      return {anchor:a, thumb, fb};
    }

    // Desktop: <object> preview
    function addObjectPreview(thumb, url){
      const obj = document.createElement('object');
      obj.type = 'application/pdf';
      obj.setAttribute('aria-label', 'Poster preview');
      obj.style.width = '100%';
      obj.style.height = '100%';
      obj.dataset.src = url + '#page=1&view=FitH';
      thumb.prepend(obj); // below the badge/fallback stacking order
      obj.addEventListener('error', () => {
        const fb = thumb.querySelector('.fallback');
        if (fb) fb.textContent = 'Preview unavailable';
      });
      return obj;
    }

    // Mobile: PDF.js canvas render
    async function renderCanvasInto(thumb, url){
      try{
        const loadingTask = pdfjsLib.getDocument({ url });
        const pdf = await loadingTask.promise;
        const page = await pdf.getPage(1);
        // choose scale for mobile-friendly resolution
        const viewport = page.getViewport({ scale: 0.5 });
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        await page.render({ canvasContext: ctx, viewport }).promise;
        // Insert below badge
        thumb.prepend(canvas);
        const fb = thumb.querySelector('.fallback');
        if (fb) fb.style.display = 'none';
      }catch(e){
        const fb = thumb.querySelector('.fallback');
        if (fb) fb.textContent = 'Preview unavailable';
        console.warn('Mobile canvas render failed for', url, e);
      }
    }

    // Lazy loader
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){
          const el = entry.target;
          io.unobserve(el);
          const url = el.dataset.url;
          if (!url) return;
          if (preferCanvas){
            if (!el.dataset.loaded){
              el.dataset.loaded = '1';
              renderCanvasInto(el, url);
            }
          } else {
            if (!el.dataset.loaded){
              el.dataset.loaded = '1';
              const obj = addObjectPreview(el, url);
              const src = obj.dataset.src;
              // force attribute write on next frame to trigger load
              requestAnimationFrame(()=> obj.setAttribute('data', src));
            }
          }
        }
      });
    }, { rootMargin: '200px' });

    async function probe(url){
      try{
        const res = await fetch(url, { method:'HEAD', cache:'no-store' });
        return res.ok;
      }catch{
        try{
          const res = await fetch(url, { method:'GET', headers:{ 'Range':'bytes=0-0' }, cache:'no-store' });
          return res.ok;
        }catch{ return false; }
      }
    }

    (async function build(){
      const map = await loadCSVMap();
      let misses = 0;
      const cards = [];

      for(let n=1;n<=MAX;n++){
        const id = STEM + PAD(n);
        const file = `${id}.pdf`;
        const url  = PREFIX + file;
        const ok = await probe(url);
        if(ok){
          misses = 0;
          const meta = map[id] || null;
          cards.push({ id, url, meta });
        }else{
          misses++;
          if(misses >= MAX_CONSEC_MISSES) break;
        }
      }

      // Sort by numeric id
      cards.sort((a,b)=> a.id.localeCompare(b.id, undefined, { numeric:true }));

      if(!cards.length){
        const p = document.createElement('p');
        p.style.color = 'var(--muted)';
        p.textContent = 'No posters found. Upload PDFs as P01.pdf, P02.pdf, … into assets/posters/. Optionally add posters.csv (id,title,authors).';
        grid.appendChild(p);
        return;
      }

      for(const c of cards){
        const {anchor, thumb} = makeCardShell(c.id, c.url, c.meta);
        thumb.dataset.url = c.url;
        grid.appendChild(anchor);
        io.observe(thumb);
      }
    })();
  })();
  </script>
</body>
</html>
