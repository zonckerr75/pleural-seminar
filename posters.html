<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Posters — Pleural Seminar Wales 2025</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{ --bg:#0b1320;--panel:#0f172a;--fg:#e5e7eb;--muted:#94a3b8;--accent:#22c55e;--border:#1f2937; --overlay: rgba(2,6,23,0.85); }
    html,body{height:100%}
    body{ margin:0;background:var(--bg);color:var(--fg); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif; display:flex;min-height:100vh }
    aside.nav{ width:260px;background:var(--panel);border-right:1px solid var(--border); position:sticky;top:0;height:100vh;padding:20px;display:none }
    @media (min-width: 1024px){ aside.nav{display:block} }
    main{flex:1;min-width:0;padding:20px}
    header.page{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}
    header.page h1{font-size:22px;margin:0}
    header.page p{color:var(--muted);margin:0}
    .toolbar{ display:flex;align-items:center;gap:12px;flex-wrap:wrap; background:var(--panel);border:1px solid var(--border);border-radius:12px; padding:8px 10px }
    .toggle{display:flex;align-items:center;gap:8px}
    .switch{ width:42px;height:24px;background:#111827;border:1px solid var(--border); border-radius:999px;position:relative;cursor:pointer;flex-shrink:0 }
    .switch::after{ content:"";position:absolute;top:2px;left:2px;width:20px;height:20px; background:#e5e7eb;border-radius:50%;transition:transform .18s ease; }
    .switch.on{ background:#083d1b;border-color:#0b5; } .switch.on::after{ transform: translateX(18px); }
    .label{color:var(--muted);font-size:14px}
    .grid{ display:grid;gap:12px; grid-template-columns: repeat(1, minmax(0, 1fr)); }
    @media (min-width: 640px){ .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (min-width: 1024px){ .grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (min-width: 1280px){ .grid{ grid-template-columns: repeat(4, minmax(0,1fr)); } }
    .card{ background:var(--panel);border:1px solid var(--border);border-radius:14px; overflow:hidden;display:flex;flex-direction:column;min-height:200px;position:relative }
    .thumb{ aspect-ratio:4/3;display:flex;align-items:center;justify-content:center; border-bottom:1px solid var(--border);position:relative;background:#0c1527 }
    .thumb img{ width:100%;height:100%;object-fit:contain;display:block }
    .badge{ position:absolute;top:8px;left:8px;background:rgba(34,197,94,.15);color:#86efac; font-weight:600;font-size:12px;padding:3px 7px;border-radius:999px;border:1px solid rgba(134,239,172,.3) }
    .quickopen{ position:absolute;top:8px;right:8px;background:rgba(255,255,255,.05); border:1px solid var(--border);color:var(--fg);padding:4px 8px;border-radius:10px; font-size:12px;text-decoration:none }
    .info{padding:10px}
    .title{font-weight:600;margin:0 0 4px 0;font-size:15px;line-height:1.3}
    .meta{color:var(--muted);font-size:13px;margin:0}
    .open{ text-decoration:none;color:var(--fg);display:block }
    .open:focus-visible{outline:2px solid var(--accent);outline-offset:4px;border-radius:12px}
    .modal{ position:fixed;inset:0;background:var(--overlay); display:none;align-items:stretch;justify-content:center;z-index:1000 }
    .modal.active{ display:flex }
    .viewer{ margin:auto;background:var(--panel);border:1px solid var(--border); width:min(1200px, 96vw);height:min(86vh, 900px);border-radius:16px;display:flex;flex-direction:column;overflow:hidden }
    .viewer header{ display:flex;align-items:center;justify-content:space-between;gap:8px; padding:10px 12px;border-bottom:1px solid var(--border) }
    .viewer header .left{ display:flex;align-items:center;gap:10px;min-width:0 }
    .viewer h3{margin:0;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .viewframe{ position:relative;flex:1;background:#0b1224 }
    .viewframe canvas{ position:absolute;inset:0;width:100%;height:100%;border:0;background:#0b1224 }
    .loading{ position:absolute;inset:0;display:none;align-items:center;justify-content:center;color:var(--muted);font-size:14px }
    .loading.active{ display:flex }
    .controls{ display:flex;align-items:center;gap:8px }
    .btn{ background:#0f1a33;border:1px solid var(--border);color:var(--fg); padding:6px 10px;border-radius:10px;cursor:pointer;font-size:14px }
    .btn:hover{ background:#122043 }
    .btn.secondary{ background:transparent }
    .indexdot{ font-feature-settings:"tnum" 1; font-variant-numeric: tabular-nums; color:var(--muted); font-size:12px }
    @media (max-width: 640px){ .viewer{ height:88vh;width:96vw } .viewer header{ padding:8px } .btn{ padding:6px 8px } .title{ font-size:14px } }
  </style>
</head>
<body>
  <aside class="nav">
    <h3 style="margin-top:0">Pleural Seminar</h3>
    <nav>
      <a href="index.html" style="display:block;color:var(--fg);margin:8px 0">Home</a>
      <a href="venue.html" style="display:block;color:var(--fg);margin:8px 0">Venue</a>
      <a href="faculty.html" style="display:block;color:var(--fg);margin:8px 0">Faculty</a>
      <a href="feedback.html" style="display:block;color:var(--fg);margin:8px 0">Feedback</a>
      <a href="about.html" style="display:block;color:var(--fg);margin:8px 0">About</a>
      <span style="display:block;color:var(--muted);margin:8px 0">Posters</span>
    </nav>
  </aside>

  <main>
    <header class="page">
      <h1>Posters</h1>
      <div class="toolbar">
        <div class="toggle">
          <div id="gallerySwitch" class="switch on" role="switch" aria-checked="true" tabindex="0"></div>
          <span class="label">Gallery mode (modal with Next/Back). Toggle off to open PDFs in a new tab.</span>
        </div>
      </div>
      <p class="label" id="csvStatus" style="display:none"></p>
    </header>

    <section class="grid" id="posterGrid" aria-live="polite"></section>
  </main>

  <div class="modal" id="posterModal" aria-hidden="true" role="dialog" aria-label="Poster viewer">
    <div class="viewer">
      <header>
        <div class="left">
          <button class="btn secondary" id="btnClose" aria-label="Close viewer">Close</button>
          <h3 id="modalTitle">Poster</h3>
        </div>
        <div class="controls">
          <span class="indexdot" id="indexDot">1 / 1</span>
          <button class="btn" id="btnPrev" aria-label="Previous poster">◀ Back</button>
          <button class="btn" id="btnNext" aria-label="Next poster">Next ▶</button>
          <a class="btn secondary" id="btnOpen" target="_blank" rel="noopener">Open in new tab</a>
        </div>
      </header>
      <div class="viewframe" id="viewframe">
        <div class="loading" id="loading">Loading…</div>
        <canvas id="pdfCanvas"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";
    }
  </script>

  <script>
  (function(){
    const grid = document.getElementById('posterGrid');
    const csvStatus = document.getElementById('csvStatus');
    const gallerySwitch = document.getElementById('gallerySwitch');

    const modal = document.getElementById('posterModal');
    const viewframe = document.getElementById('viewframe');
    const pdfCanvas = document.getElementById('pdfCanvas');
    const modalTitle = document.getElementById('modalTitle');
    const btnOpen = document.getElementById('btnOpen');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const btnClose= document.getElementById('btnClose');
    const indexDot = document.getElementById('indexDot');
    const loading = document.getElementById('loading');

    const PREFIX = 'assets/posters/';
    const CSV_URL = PREFIX + 'posters.csv';
    const SIZES_ATTR = '(min-width:1280px) 22vw, (min-width:1024px) 30vw, (min-width:640px) 44vw, 92vw';

    function getUseGallery(){ const v = localStorage.getItem('useGallery'); return v === null ? true : v === 'true'; }
    function setUseGallery(val){ localStorage.setItem('useGallery', String(val)); gallerySwitch.classList.toggle('on', val); gallerySwitch.setAttribute('aria-checked', String(val)); }
    setUseGallery(getUseGallery());
    gallerySwitch.addEventListener('click', ()=> setUseGallery(!getUseGallery()));
    gallerySwitch.addEventListener('keydown', (e)=>{ if (e.key === ' ' || e.key === 'Enter'){ e.preventDefault(); setUseGallery(!getUseGallery()); } });

    function parseCSV(text){
      text = text.replace(/^﻿/, '');
      const lines = text.split(/[
]+/).map(l=>l.trim()).filter(Boolean);
      let start = 0;
      let idIdx = 0, titleIdx = 1, authorsIdx = 2;
      if (/^id\s*,/i.test(lines[0] || '')){
        const hdr = lines[0].split(',').map(s=>s.trim().toLowerCase());
        idIdx = hdr.indexOf('id'); titleIdx = hdr.indexOf('title'); authorsIdx = hdr.indexOf('authors');
        start = 1;
      }
      const out = [];
      for (let i=start;i<lines.length;i++){
        const parts = lines[i].split(',').map(s=>s.trim());
        const id = parts[idIdx] || ''; const title = parts[titleIdx] || ''; const authors = parts.slice(authorsIdx).join(', ').trim();
        if (!/^p?\d+/i.test(id)) continue;
        out.push({ id: id.toUpperCase().replace(/^P?/, 'P'), title, authors });
      }
      return out;
    }

    function buildCard(row, idx){
      const id = row.id;
      const pdfUrl = PREFIX + id + '.pdf';
      const candidates = [
        PREFIX + id.toLowerCase() + '.jpg', PREFIX + id + '.jpg', PREFIX + id.toUpperCase() + '.jpg',
        PREFIX + id.toLowerCase() + '.png', PREFIX + id + '.png',
        PREFIX + id.toLowerCase() + '.webp', PREFIX + id + '.webp',
      ];

      const useGallery = getUseGallery();
      const a = document.createElement('a'); a.className = 'open';
      if (useGallery){ a.href = '#'; a.addEventListener('click', (e)=>{ e.preventDefault(); openModal(idx); }); }
      else { a.href = pdfUrl; a.target = '_blank'; a.rel = 'noopener'; }

      const card = document.createElement('article'); card.className = 'card';
      const thumb = document.createElement('div'); thumb.className = 'thumb';
      const img = document.createElement('img'); img.loading='lazy'; img.decoding='async';
      img.alt = (row.title ? row.title + ' — ' : '') + id + ' thumbnail'; img.sizes = SIZES_ATTR;
      img.dataset.fallbacks = candidates.slice(1).join('|'); img.src = candidates[0];
      img.onerror = function(){ const list=(this.dataset.fallbacks||'').split('|').filter(Boolean); if(!list.length){this.onerror=null;this.style.display='none';return;} this.src=list.shift(); this.dataset.fallbacks=list.join('|'); };
      const badge = document.createElement('span'); badge.className='badge'; badge.textContent = id;
      const quick = document.createElement('a'); quick.href = pdfUrl; quick.target='_blank'; quick.rel='noopener'; quick.className='quickopen'; quick.textContent='Open';

      thumb.appendChild(img); thumb.appendChild(badge); thumb.appendChild(quick);

      const info = document.createElement('div'); info.className='info';
      const title = document.createElement('h3'); title.className='title'; title.textContent = row.title || id;
      const meta = document.createElement('p'); meta.className='meta'; meta.textContent = row.authors || 'Tap to open';
      info.appendChild(title); info.appendChild(meta);

      card.appendChild(thumb); card.appendChild(info); a.appendChild(card);
      return a;
    }

    async function init(){
      try{
        const res = await fetch(CSV_URL, { cache:'no-store' });
        if (!res.ok) throw new Error('posters.csv not found');
        const text = await res.text();
        const rows = parseCSV(text);
        rows.sort((a,b)=> a.id.localeCompare(b.id, undefined, { numeric:true }));
        csvStatus.textContent = 'Loaded ' + rows.length + ' posters'; csvStatus.style.display='none';
        rows.forEach((row, idx)=> grid.appendChild(buildCard(row, idx)));
      } catch (e){
        const p = document.createElement('p'); p.style.color = 'var(--muted)';
        p.textContent = 'Could not load posters.csv — ensure it exists at assets/posters/posters.csv';
        grid.appendChild(p); console.warn(e);
      }
    }

    // Modal — canvas-only PDF.js
    const posters = []; let currentIndex = 0;
    function rebuildPostersFromGrid(){
      posters.length = 0;
      const cards = Array.from(document.querySelectorAll('.grid .open'));
      cards.forEach(card => {
        const id = card.querySelector('.badge').textContent.trim();
        const title = card.querySelector('.title').textContent.trim();
        const meta = card.querySelector('.meta').textContent.trim();
        posters.push({ id, title, authors: meta, pdfUrl: PREFIX + id + '.pdf' });
      });
    }
    function openModal(index){
      rebuildPostersFromGrid(); if (!posters.length) return;
      currentIndex = (index + posters.length) % posters.length;
      const p = posters[currentIndex];
      modalTitle.textContent = (p.title ? p.title + ' — ' : '') + p.id;
      btnOpen.href = p.pdfUrl;
      indexDot.textContent = (currentIndex+1) + ' / ' + posters.length;
      renderPdfToCanvas(p.pdfUrl, pdfCanvas);
      modal.classList.add('active'); modal.setAttribute('aria-hidden','false');
      document.body.style.overflow='hidden';
    }
    function closeModal(){
      modal.classList.remove('active'); modal.setAttribute('aria-hidden','true');
      document.body.style.overflow='';
      const ctx = pdfCanvas.getContext('2d'); ctx && ctx.clearRect(0,0,pdfCanvas.width,pdfCanvas.height);
    }
    function nextModal(){ openModal(currentIndex+1); }
    function prevModal(){ openModal(currentIndex-1); }
    btnNext.addEventListener('click', nextModal); btnPrev.addEventListener('click', prevModal);
    btnClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });
    window.addEventListener('keydown', (e)=>{ if (!modal.classList.contains('active')) return; if (e.key==='Escape') closeModal(); if (e.key==='ArrowRight') nextModal(); if (e.key==='ArrowLeft') prevModal(); });

    // Swipe
    let sx=0, sy=0, active=false; viewframe.addEventListener('touchstart', (e)=>{ const t=e.changedTouches[0]; sx=t.clientX; sy=t.clientY; active=true; }, {passive:true});
    viewframe.addEventListener('touchend', (e)=>{ if(!active) return; active=false; const t=e.changedTouches[0]; const dx=t.clientX-sx, dy=t.clientY-sy; if(Math.abs(dx)>50 && Math.abs(dx)>Math.abs(dy)*1.5){ if(dx<0) nextModal(); else prevModal(); } }, {passive:true});

    async function getPdfDoc(url){
      try{
        const r = await fetch(url, { cache:'no-store', mode:'same-origin', credentials:'same-origin' });
        if (!r.ok) throw new Error('Fetch failed '+r.status);
        const buf = await r.arrayBuffer();
        return await pdfjsLib.getDocument({ data: buf }).promise;
      }catch(e){
        return await pdfjsLib.getDocument({ url, disableRange:true, disableStream:true }).promise;
      }
    }
    async function renderPdfToCanvas(url, canvas){
      loading.classList.add('active');
      try{
        const pdf = await getPdfDoc(url);
        const page = await pdf.getPage(1);
        const rect = canvas.parentElement.getBoundingClientRect();
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        const viewport = page.getViewport({ scale: 1 });
        const scale = Math.min(rect.width / viewport.width, rect.height / viewport.height);
        const scaled = page.getViewport({ scale: scale * dpr });
        canvas.width = Math.floor(scaled.width);
        canvas.height = Math.floor(scaled.height);
        canvas.style.width = Math.floor(scaled.width / dpr) + 'px';
        canvas.style.height = Math.floor(scaled.height / dpr) + 'px';
        const ctx = canvas.getContext('2d', { alpha:false });
        await page.render({ canvasContext: ctx, viewport: scaled }).promise;
      }catch(e){
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle='#0b1224'; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle='#94a3b8'; ctx.font='16px system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif';
        ctx.fillText('Preview unavailable — use “Open in new tab”.', 20, 40);
        console.warn('PDF render failed', e);
      }finally{
        loading.classList.remove('active');
      }
    }

    init();
  })();
  </script>
</body>
</html>